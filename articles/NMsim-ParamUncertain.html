<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation with Parameter Uncertainty • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Simulation with Parameter Uncertainty">
<meta name="google-site-verification" content="-8n-8OfzJii_lVruWfxXOhzUATKSgMdiSxMhOQoscu4">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Data Set Creation with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation with Parameter Uncertainty</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-ParamUncertain.Rmd" class="external-link"><code>vignettes/NMsim-ParamUncertain.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-ParamUncertain.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="other-relevant-material">Other relevant material<a class="anchor" aria-label="anchor" href="#other-relevant-material"></a>
</h2>
<p>Please note the following ACOP2024 poster which is more recent and
more comprehensive than this document:<br><a href="../reference/figures/NMsim_param_uncertainty_web.pdf"><strong>Simulation
of clinical trial predictions with model uncertainty using
NMsim</strong></a> (Poster T110)<br>
Authors: <strong>Sanaya Shroff</strong>, <strong>Philip
Delff</strong></p>
</div>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This vignettes aims at enabling you to use <code>NMsim</code> for the
following purposes</p>
<ul>
<li>Simulation with parameter uncertainty
<ul>
<li>By sampling from a successful covariance step</li>
<li>By using models from bootstrap sampling</li>
</ul>
</li>
</ul>
</div>
<div class="section level2">
<h2 id="simulation-of-parameter-uncertainty">Simulation of parameter uncertainty<a class="anchor" aria-label="anchor" href="#simulation-of-parameter-uncertainty"></a>
</h2>
<p>We already saw how <code>NMsim</code> can easily be used to generate
new subjects (for say prediction intervals) by using the between-subject
and between-occasion variability as described by the model. We may also
want to simulate the uncertainty of the parameter estimates (for say
confidence intervals). <code>NMsim</code> supports two different
approaches to this.</p>
<ul>
<li><p>Simulation based on the estimated variance-covariance matrix of
the parameters as estimated by a successful <code>$COVARIANCE</code>
step in Nonmem. This method is specified with the argument
<code>method.sim=NMsim_VarCov</code>.</p></li>
<li><p>Simulation based on a bootstrap of the model. NMsim cannot do the
bootstrap. But with a bootstrap at hand, <code><a href="../reference/NMsim.html">NMsim()</a></code> can reuse
the bootstrapped models for simulation. This is obtained by simply
running <code><a href="../reference/NMsim.html">NMsim()</a></code> on multiple estimated models. This requires
that the sampled bootstrap models must be available. The example below
is based on results from <code>PSN</code>’s bootstrap function.</p></li>
</ul>
<p>It must be noted that the current implementation based on the
<code>$COVARIANCE</code> step does not simulate the <code>$OMEGA</code>
and <code>$SIGMA</code> parameters from the correct distribution. For
typical value simulations, this limitation will not affect the results.
The forest plot is an example where typical subject estimates simulated
with parameter uncertainty. If the post-processing involves statistics
across simulated populations (<code>$OMEGA</code>) or residual error
(<code>$SIGMA</code>), this method should be used for preliminary
analyses.</p>
<p>It beyond the scope of this vignette to describe further pros and
cons of the two approaches. The following examples serve to exlain the
prerequisites for using <code>NMsim</code> to do it, and how to get
<code>NMsim</code> to do the job.</p>
<div class="section level3">
<h3 id="simulation-of-parameter-uncertainty-based-on-a-covariance-step">Simulation of parameter uncertainty based on a covariance step<a class="anchor" aria-label="anchor" href="#simulation-of-parameter-uncertainty-based-on-a-covariance-step"></a>
</h3>
<p>If you have a succesful covariance step from Nonmem,
<code>NMsim</code> can sample models from the estimated
variance-covariance matrix. Again, <code>NMsim</code> does not derive
confidence intervals based on the estimated variance-covariance matrix.
It samples models from it, and then you can derive the desired
confidence intervals, or whatever you need.</p>
<p>Again, we shall try not to get too far into details here, but
remember what we are doing here. We are assuming that the estimated
vairance-covariance matrix is a reliable estimate of the parameter
precision, implying Gaussian distribution of all parameter
uncertainties. The reason this is important to understand is that
depending on the model, this can lead to samples of parameter values
beyond some allowed range. This can lead some of the sampled models to
fail or not be meaningful. The point here is that a successful
covariance step may not be a sufficient criterion for picking this
approach to simulating uncertainty; appropriate parametrization is
another one.</p>
<p>Anyway, getting <code>NMsim</code> to do the work is as simple as
this:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">552</span><span class="op">)</span></span>
<span><span class="va">simlsts.VarCov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span></span>
<span>    file.mod<span class="op">=</span><span class="va">file.mod</span>,              <span class="co">## Path to estimation input control stream</span></span>
<span>    data<span class="op">=</span><span class="va">dat.sim</span>                    <span class="co">## simulation input data</span></span>
<span>   ,dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette/tmp"</span> <span class="co">## where to store temporary simulation files</span></span>
<span>   ,dir.res<span class="op">=</span><span class="st">"simulate-results"</span>      <span class="co">## where to store simulation results files</span></span>
<span>   ,table.vars<span class="op">=</span><span class="st">"PRED IPRED"</span>         <span class="co">## Let Nonmem write a minimum output table</span></span>
<span>   ,method.sim<span class="op">=</span><span class="va">NMsim_VarCov</span>         <span class="co">## Var-Cov parameter sampling</span></span>
<span>   ,name.sim<span class="op">=</span><span class="st">"VarCov"</span>               <span class="co">## a recognizable directory name</span></span>
<span>   ,nsims<span class="op">=</span><span class="fl">500</span>                       <span class="co">## sampling 500 models</span></span>
<span>   ,sge<span class="op">=</span><span class="cn">TRUE</span>                        <span class="co">## run simulations in parallel please</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>You may get messages like “Unable to run job” and that the job “is
not allowed to run in any queue”. Counter-intuitively to most, these
messages do not mean that the job isn’t run.</p>
<p>We used <code>sge=TRUE</code> which means we are sending the 1000
generated jobs to the queuing system. In this case, <code>NMsim</code>
does not track the execution of the jobs and does hence not collect the
results once they are done. Instead it returns a small data.frame with
the paths to where all the simulation output control streams will be
written. You have to check the status of the jobs manually, and once
they are all done, you can read all the results using
<code><a href="../reference/NMreadSim.html">NMreadSim()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.VarCov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simulate-results/NMsim_xgxr032_VarCov_paths.rds"</span><span class="op">)</span></span></code></pre></div>
<p>We now have simulation results from 1000 sampled models collected. We
shall do the same with the models sampled in a bootstrap, and then we
will calculate confidence intervals based on both methods.</p>
</div>
<div class="section level3">
<h3 id="simulation-from-a-bootstrap">Simulation from a bootstrap<a class="anchor" aria-label="anchor" href="#simulation-from-a-bootstrap"></a>
</h3>
<p>The other approach to simulation with parameter uncertainty currently
provided by <code>NMsim</code> is simulation from a bootstrap. Again,
<code>NMsim</code> does not run a bootstrap, it simply runs a simulation
using each of the sampled models from a bootstrap. In fact this means we
don’t even need a dedicated method to achieve this, we simply run a
simulation with multiple Nonmem models as described in the begging of
this vignette. We used <code>PSN</code>’s bootstrap. We can run the
simulation on all the models this way:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## generate a vector with paths to all the input control streams</span></span>
<span><span class="va">mods.bootstrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span>path<span class="op">=</span><span class="fu">file.project</span><span class="op">(</span><span class="st">"nonmem/bs1_032_N1000/m1"</span><span class="op">)</span>,</span>
<span>                             pattern<span class="op">=</span><span class="st">".+\\.mod$"</span>,full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## number of models to be run</span></span>
<span><span class="co">## length(mods.bootstrap)</span></span>
<span></span>
<span><span class="va">file.res.bootstrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span></span>
<span>    file.mod<span class="op">=</span><span class="va">mods.bootstrap</span>   <span class="co">## Estimation input control stream</span></span>
<span>   ,data<span class="op">=</span><span class="va">dat.sim</span>              <span class="co">## Simulation input data</span></span>
<span>   ,method.sim<span class="op">=</span><span class="va">NMsim_default</span>  <span class="co">## a single simulation with each sampled model</span></span>
<span>   ,dir.sims<span class="op">=</span><span class="st">"~/NMsim_vignette/bootstrap"</span> <span class="co">## Where to save simulation results</span></span>
<span>   ,file.res<span class="op">=</span><span class="st">"simulate-results/simres_bootstrap.rds"</span></span>
<span>   ,table.vars<span class="op">=</span><span class="st">"PRED IPRED"</span>   <span class="co">## Let Nonmem write a minimum output table</span></span>
<span>   ,sge<span class="op">=</span><span class="cn">TRUE</span>                  <span class="co">## run simulations in parallel</span></span>
<span>   ,method.update.inits<span class="op">=</span><span class="st">"nmsim"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.bootstrap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simulate-results/simres_bootstrap.rds"</span><span class="op">)</span></span></code></pre></div>
<p><code>NMsim</code> keeps a column by default called
<code>model</code> which holds the model name, derived from the control
stream file name. This behavior is due to <code>NMsim</code> relying on
the functionality implemented in <code>NMdata</code> for reading and
writing data. Using <code><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMdata::NMscanData</a></code>. As an example, we
can derive an estimated confidence interval of the population prediction
against time by summarizing across the simulation models (samples).</p>
</div>
<div class="section level3">
<h3 id="the-confidence-intervals">The confidence intervals<a class="anchor" aria-label="anchor" href="#the-confidence-intervals"></a>
</h3>
<p>Derivation of the confidence intervals is identical for the two
methods, so we do it at once using data.table’s <code>by</code> feature
to separate the two methods (sampling from covariance steps and using
the bootstrap samples).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Stacking results from the two approaches to simulating with</span></span>
<span><span class="co">## parameter uncertainty.</span></span>
<span><span class="va">allres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simres.VarCov</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"Covariance step"</span><span class="op">]</span>,</span>
<span>                <span class="va">simres.bootstrap</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"Bootstrap"</span><span class="op">]</span>,</span>
<span>                fill<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## long format so calculations can be done by prediction type.</span></span>
<span><span class="va">allresl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">allres</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>                measure.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span><span class="op">)</span>,</span>
<span>                variable.name<span class="op">=</span><span class="st">"pred.type"</span>,</span>
<span>                value.name<span class="op">=</span><span class="st">"pred.value"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## deriving median by model and time to have a single value per model</span></span>
<span><span class="co">## and time point. This is only needed in case multiple subjects are</span></span>
<span><span class="co">## simulated by each model.</span></span>
<span><span class="va">sum.res.model</span> <span class="op">&lt;-</span> <span class="va">allresl</span><span class="op">[</span>,</span>
<span>                         <span class="fu">.</span><span class="op">(</span>predm<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">pred.value</span><span class="op">)</span><span class="op">)</span></span>
<span>                        ,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">method</span>,<span class="va">model</span>,<span class="va">TIME</span>,<span class="va">pred.type</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="va">sum.res.model</span><span class="op">[</span></span>
<span>   ,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">predm</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.025</span>,<span class="fl">.5</span>,<span class="fl">.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"predml"</span>,<span class="st">"predmm"</span>,<span class="st">"predmu"</span><span class="op">)</span><span class="op">)</span></span>
<span>   ,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">method</span>,<span class="va">TIME</span>,<span class="va">pred.type</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Plotting the two next to each other. For this simple model with a
smooth covariance step the two confidence intervals are very similar. If
you look hard, you can see minor differences.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sum.uncertain</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TIME</span>,fill<span class="op">=</span><span class="va">pred.type</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">predml</span>,ymax<span class="op">=</span><span class="va">predmu</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">predmm</span>,colour<span class="op">=</span><span class="va">pred.type</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-ParamUncertain_files/figure-html/uncertain-plots-1.png" width="672"></p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
