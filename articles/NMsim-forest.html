<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Simulation-Based Forest Plots with NMsim • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="Simulation-Based Forest Plots with NMsim">
<meta name="google-site-verification" content="-8n-8OfzJii_lVruWfxXOhzUATKSgMdiSxMhOQoscu4">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Data Set Creation with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Simulation-Based Forest Plots with NMsim</h1>
                        <h4 data-toc-skip class="author">Philip Delff,
Boris Grinshpun</h4>
                        
            <h4 data-toc-skip class="date">May 21, 2025 using NMsim
0.2.3</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-forest.Rmd" class="external-link"><code>vignettes/NMsim-forest.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-forest.Rmd</code></div>
    </div>

    
    
<p><img src="../reference/figures/NMsimlogo240.png" align="right" height="120" alt="NMsim"></p>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The forest plot is an effective and widely recognized way to
illustrate estimated covariate effects on exposure or response, or
parameters related to these (e.g. clearance). The forest plot typically
includes precision of the estimate in terms of a confidence interval.
NMsim provides highly automated methods for simulation of Nonmem models
for generation of forest plots.</p>
<div class="section level3">
<h3 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h3>
<p>This short demonstration of generation of simulation-based forest
plots using NMsim is intended to make the user ready to perform the
following steps.</p>
<ul>
<li>Generate simulation data sets designed for forest plot simulations
<ul>
<li>Dosing and sampling scheme using <code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code>
</li>
<li>Define covariates to simulate using
<code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code>
</li>
</ul>
</li>
<li>Simulate with parameter uncertainty by one of
<ul>
<li>Based on <code>$COV</code> using <code><a href="../reference/NMsim_NWPRI.html">NMsim_NWPRI()</a></code>
</li>
<li>Based on <code>$COV</code> using <code><a href="../reference/NMsim_VarCov.html">NMsim_VarCov()</a></code>
</li>
<li>Using an existent bootstrap estimation (e.g. from PSN)</li>
</ul>
</li>
<li>Postprocess simulation for plotting/tabulation
<ul>
<li>Define end-points, such as an AUC, Cmax or any simulation-based
endpoint</li>
<li>Summarize covariate effect estimates with confidence intervals,
using <code><a href="../reference/forestSummarize.html">forestSummarize()</a></code>
</li>
</ul>
</li>
<li>Plot the summary as a forest plot</li>
</ul>
<p>Each step is facilitated with efficient interfaces (R functions) and
automated execution. Essentially, each step above is one function call.
The results from all methods are compared in one plot.</p>
<p>Plotting is includied in the example using the
<code>coveffectsplot</code> package. Other packages or user’s own
scripts can be used for plotting.</p>
<p>We shall focus the main example to be simple and general. Hopefully,
the user will be able to customize and apply a similar workflow to their
own models with minimum effort. Folded code-chunks and references will
be provided for additional features.</p>
</div>
<div class="section level3">
<h3 id="prerequisites">Prerequisites<a class="anchor" aria-label="anchor" href="#prerequisites"></a>
</h3>
<ul>
<li>An estimated Nonmem model - at least, input control stream and
<code>.ext</code> file.
<ul>
<li>If simulating based on <code>$COVARIANCE</code>, the
<code>.cov</code> file.</li>
<li>If simulating based on bootstrap, either a summary of or all the
<code>.ext</code> files from the boot strap estimations must be
available.</li>
<li>If references and/or covariate quantile values are to be calculated
by NMsim (easiest option), ideally all output (<code>$TABLE</code>) data
sets and the input data set used for the estimation are available.</li>
</ul>
</li>
<li>Familiarity with <a href="https://NMautoverse.github.io/NMsim/articles/NMsim-intro.html"><code>NMsim-intro.html</code></a>,
at least including “A first simulation with <code><a href="../reference/NMsim.html">NMsim()</a></code>”.</li>
<li>Configuration of NMsim so user can succesfully do simulation using
<code><a href="../reference/NMsim.html">NMsim()</a></code>.</li>
<li>Familiarity with methods to simulate with parameter uncertainty can
be helpful. Before settling on your final forest plot simulation, it is
recommended to understand pros and cons of the different methods
provided by NMsim as described in <a href="https://NMautoverse.github.io/NMsim/articles/NMsim-ParamUncertain.html"><code>NMsim-ParamUncertain.html</code></a>.</li>
</ul>
</div>
<div class="section level3">
<h3 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h3>
<p>Forest plots include a confidence interval of the estimated or
simulated effect. The confidence interval is derived from uncertainy
estimates of the parameter set. This is not between-subject variability
(BSV), also called intra-individual variability. For NMsim to simulate
the distribution of the covariate effect, this uncertainty must be
obtained through one of two sources. Either as the result of a
succesfull <code>$COVARIANCE</code> step on the model, or using an
already executed bootstrap.</p>
<p>In some cases, the forest plot can be derived based on model
estimates without simulation. This is the case for a forest plots of PK
parameters such as clearance when a covariance step is available, and it
can be the case with forest plots of exposure metrics if the PK is
linear and only steady-state average concentration (or AUC) is of
interest. If the PK is non-linear and/or exposure metrics such as Cmax
which depends on multiple PK parameters are of interest, a
simulation-based forest plot may be needed. As we shall see, NMsim
provides a flexible and concise framework to perform the required. In
fact, the simulation-based workflow is so general and easy to perform
that it may be prefered even in cases where simulation is not
needed.</p>
</div>
</div>
<div class="section level2">
<h2 id="initialization">Initialization<a class="anchor" aria-label="anchor" href="#initialization"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://NMautoverse.github.io/NMsim/">NMsim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nmautoverse.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span>  </span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">NMcalc</span><span class="op">)</span>  <span class="co">## Optional. Used to calculate AUC.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://smouksassi.github.io/coveffectsplot/" class="external-link">coveffectsplot</a></span><span class="op">)</span> <span class="co">## used for plotting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://yihui.org/knitr/" class="external-link">knitr</a></span><span class="op">)</span> <span class="co">## for printing tables with knitr::kable</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lionel-/ggstance" class="external-link">ggstance</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span></span>
<span>    path.nonmem <span class="op">=</span> <span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span>, <span class="co">## path to NONMEM executable</span></span>
<span>    dir.sims<span class="op">=</span><span class="st">"simtmp-forest"</span>, <span class="co">## where to store temporary simulation results</span></span>
<span>    dir.res<span class="op">=</span><span class="st">"simres-forest"</span>   <span class="co">## where to store final simulation results</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A model is selected.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## file.mod &lt;- "NMsim-forest-models/xgxr134.mod"</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr134.mod"</span>,package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generation-of-simulation-input-data">Generation of simulation input data<a class="anchor" aria-label="anchor" href="#generation-of-simulation-input-data"></a>
</h2>
<div class="section level3">
<h3 id="dosing-and-sampling">Dosing and sampling<a class="anchor" aria-label="anchor" href="#dosing-and-sampling"></a>
</h3>
<p>The simulation data set has to match the model in compartment
numbers, and it must contain all variables needed to run the NONMEM
model. We simulate daily dosing of 30 mg. <code>col.id=NA</code> to omit
a subject id in <code>doses</code> as we will instead reuse it for
multiple subjects.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fl">0</span>,AMT<span class="op">=</span><span class="fl">30</span>,ADDL<span class="op">=</span><span class="fl">30</span>,II<span class="op">=</span><span class="fl">24</span><span class="op">)</span></span>
<span><span class="va">doses</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr class="header">
<th align="right">ID</th>
<th align="right">TIME</th>
<th align="right">EVID</th>
<th align="right">CMT</th>
<th align="right">AMT</th>
<th align="right">II</th>
<th align="right">ADDL</th>
<th align="right">MDV</th>
</tr></thead>
<tbody><tr class="odd">
<td align="right">1</td>
<td align="right">0</td>
<td align="right">1</td>
<td align="right">1</td>
<td align="right">30</td>
<td align="right">24</td>
<td align="right">30</td>
<td align="right">1</td>
</tr></tbody>
</table>
</div>
<p>We sample every 15 minutes on the first day and one day in
steady-state.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## add a sampling scheme</span></span>
<span><span class="va">time.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">.25</span><span class="op">)</span>, <span class="co">## Day 1</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span>,<span class="fl">.25</span><span class="op">)</span><span class="op">+</span><span class="fl">30</span><span class="op">*</span><span class="fl">24</span> <span class="co">## Steady-State</span></span>
<span><span class="op">)</span></span>
<span><span class="va">dt.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">doses</span>,TIME<span class="op">=</span><span class="va">time.sim</span>,CMT<span class="op">=</span><span class="fl">2</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">dt.sim</span><span class="op">[</span><span class="va">TIME</span><span class="op">&lt;=</span><span class="fl">24</span>,<span class="va">period</span><span class="op">:=</span><span class="st">"Day 1"</span><span class="op">]</span></span>
<span><span class="va">dt.sim</span><span class="op">[</span><span class="va">TIME</span><span class="op">&gt;=</span><span class="fl">30</span><span class="op">*</span><span class="fl">24</span><span class="op">&amp;</span><span class="va">TIME</span><span class="op">&lt;=</span><span class="fl">31</span><span class="op">*</span><span class="fl">24</span>,<span class="va">period</span><span class="op">:=</span><span class="st">"Steady-State"</span><span class="op">]</span></span></code></pre></div>
<p>The following table summarizes the number of doses and samples.
Notice, the doses are repeated.</p>
<div class="kable-table">
<table class="table">
<thead><tr class="header">
<th align="left">period</th>
<th align="right">EVID</th>
<th align="right">ADDL</th>
<th align="right">II</th>
<th align="right">N</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Day 1</td>
<td align="right">1</td>
<td align="right">30</td>
<td align="right">24</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">Day 1</td>
<td align="right">2</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">97</td>
</tr>
<tr class="odd">
<td align="left">Steady-State</td>
<td align="right">2</td>
<td align="right">NA</td>
<td align="right">NA</td>
<td align="right">97</td>
</tr>
</tbody>
</table>
</div>
<details><summary>
How to sample multiple endpoints
</summary><p>There is only one analyte in this data set. If for instance, you have
a parent and a metabolite, adding sampling times could look like
this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt.sim.parent.metab</span> <span class="op">&lt;-</span></span>
<span>    <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">doses</span>,TIME<span class="op">=</span><span class="va">time.sim</span>,CMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>analyte<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"parent"</span>,<span class="st">"metabolite"</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We also add “Time after previous dose” which is helpful for plotting.
This is done using <code>NMdata::TAPD()</code></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dt.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">addTAPD</a></span><span class="op">(</span><span class="va">dt.sim</span><span class="op">)</span></span></code></pre></div>
<p>We used the <code>period</code> column to distinguish time intervals
for the analysis. We have to remember to do the postprocessing by the
values in that column. If you are looking at multiple analytes, remember
to postprocess by the column that distringuishes those, too. In this
example, that would be <code>analyte</code>.</p>
</details>
</div>
<div class="section level3">
<h3 id="define-covariates-to-analyze">Define covariates to analyze<a class="anchor" aria-label="anchor" href="#define-covariates-to-analyze"></a>
</h3>
<p><code><a href="../reference/forestDefineCovs.html">NMsim::forestDefineCovs()</a></code> can be used to construct a set
of covariate value combinations needed to derive a forest plot. It
varies one covariate at a time, keeping all other covariates at their
reference value. It can derive references and quantiles from a data
set.</p>
<p>For reference values we use median in the observed population for
continuous covariates and manually select “Female” as the reference for
sex. Here is a short example:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## reading output and input tables from estimation. Used to determine</span></span>
<span><span class="co">## reference values and quantiles.</span></span>
<span><span class="va">data.ref</span> <span class="op">&lt;-</span> <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">## Specifying the covariates</span></span>
<span><span class="va">covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forestDefineCovs.html">forestDefineCovs</a></span><span class="op">(</span></span>
<span>    AGE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="fl">55</span>,values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">35</span>,<span class="fl">45</span>,<span class="fl">65</span>,<span class="fl">75</span><span class="op">)</span>,label<span class="op">=</span><span class="st">"Age (years)"</span><span class="op">)</span>, <span class="co">## Age by specific values</span></span>
<span>    <span class="co">## notice, values OR quantiles can be provided</span></span>
<span>    WEIGHTB<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="va">median</span>, quantiles<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">25</span>,<span class="fl">75</span>,<span class="fl">90</span><span class="op">)</span><span class="op">/</span><span class="fl">100</span>, label<span class="op">=</span><span class="st">"Bodyweight (kg)"</span><span class="op">)</span>, <span class="co">## Bodyweight by quantiles</span></span>
<span>    MALEN<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ref<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Female<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>Male<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, label<span class="op">=</span><span class="st">"Sex"</span><span class="op">)</span>, <span class="co">## Sex is treated categorical</span></span>
<span>    data<span class="op">=</span><span class="va">data.ref</span>,</span>
<span>    as.fun<span class="op">=</span><span class="st">"data.table"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ul>
<li>We read the estimation data set <code>data.ref</code>, and pass that
as the <code>data</code> argument to <code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code>.
Using this, <code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code> can evaluate specified
quantiles of covariates on the observed or any desired population.</li>
<li>We specify reference values and simulation covariate values as
specific values (see <code>AGE</code>) or covariate quantiles
(<code>WEIGHTB</code>). If quantiles are derived by
<code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code>, the names of the covariates (here,
<code>AGE</code>, <code>WEIGTB</code>, <code>MALEN</code>) must be
columns in <code>data</code>.</li>
<li>For categorical variables, we can label numeric values like
<code>ref=c(Female=0)</code> which means we label <code>MALEN==0</code>
as “Female”.</li>
</ul>
<p>When deriving quantiles, <code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code> will first
derive unique covariate values for each subject in the data set, then
derive the quantiles. Each subject hence contributes equally,
independently of how many data points they contribute.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## adding distinct ID's for each combination of covariates</span></span>
<span><span class="va">covs</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">type</span>,<span class="va">covvar</span>,<span class="va">covval</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="kable-table">
<table style="width:100%;" class="table">
<colgroup>
<col width="10%">
<col width="9%">
<col width="10%">
<col width="21%">
<col width="9%">
<col width="8%">
<col width="5%">
<col width="8%">
<col width="10%">
<col width="4%">
</colgroup>
<thead><tr class="header">
<th align="left">covvar</th>
<th align="right">covval</th>
<th align="left">covvalc</th>
<th align="left">covlabel</th>
<th align="right">covref</th>
<th align="left">type</th>
<th align="right">AGE</th>
<th align="right">MALEN</th>
<th align="right">WEIGHTB</th>
<th align="right">ID</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">NA</td>
<td align="left">NA</td>
<td align="right">NA</td>
<td align="left">ref</td>
<td align="right">55</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">1</td>
</tr>
<tr class="even">
<td align="left">AGE</td>
<td align="right">35</td>
<td align="left">35</td>
<td align="left">Age (years)</td>
<td align="right">55</td>
<td align="left">value</td>
<td align="right">35</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">2</td>
</tr>
<tr class="odd">
<td align="left">AGE</td>
<td align="right">45</td>
<td align="left">45</td>
<td align="left">Age (years)</td>
<td align="right">55</td>
<td align="left">value</td>
<td align="right">45</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">3</td>
</tr>
<tr class="even">
<td align="left">AGE</td>
<td align="right">65</td>
<td align="left">65</td>
<td align="left">Age (years)</td>
<td align="right">55</td>
<td align="left">value</td>
<td align="right">65</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">4</td>
</tr>
<tr class="odd">
<td align="left">AGE</td>
<td align="right">75</td>
<td align="left">75</td>
<td align="left">Age (years)</td>
<td align="right">55</td>
<td align="left">value</td>
<td align="right">75</td>
<td align="right">0</td>
<td align="right">110</td>
<td align="right">5</td>
</tr>
<tr class="even">
<td align="left">WEIGHTB</td>
<td align="right">85</td>
<td align="left">85</td>
<td align="left">Bodyweight (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">55</td>
<td align="right">0</td>
<td align="right">85</td>
<td align="right">6</td>
</tr>
<tr class="odd">
<td align="left">WEIGHTB</td>
<td align="right">96</td>
<td align="left">96</td>
<td align="left">Bodyweight (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">55</td>
<td align="right">0</td>
<td align="right">96</td>
<td align="right">7</td>
</tr>
<tr class="even">
<td align="left">WEIGHTB</td>
<td align="right">130</td>
<td align="left">130</td>
<td align="left">Bodyweight (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">55</td>
<td align="right">0</td>
<td align="right">130</td>
<td align="right">8</td>
</tr>
<tr class="odd">
<td align="left">WEIGHTB</td>
<td align="right">140</td>
<td align="left">140</td>
<td align="left">Bodyweight (kg)</td>
<td align="right">110</td>
<td align="left">value</td>
<td align="right">55</td>
<td align="right">0</td>
<td align="right">140</td>
<td align="right">9</td>
</tr>
<tr class="even">
<td align="left">MALEN</td>
<td align="right">1</td>
<td align="left">Male</td>
<td align="left">Sex</td>
<td align="right">0</td>
<td align="left">value</td>
<td align="right">55</td>
<td align="right">1</td>
<td align="right">110</td>
<td align="right">10</td>
</tr>
</tbody>
</table>
</div>
<p>We now have all combinations of covariates in the object called
<code>covs</code>. Notice the <code>type</code> column which
distinguishes the reference combination in contrast to the other
simulations where one covariate is being varied at a time.</p>
<details><summary>
Plots of Typical-Subject Simulations
</summary><div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## repeating the doses for all combinations of covariates. Using NMdata::egdt()</span></span>
<span><span class="va">dt.sim.noid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dt.sim</span><span class="op">)</span><span class="op">[</span>,<span class="op">!</span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">dt.sim.covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/egdt.html" class="external-link">egdt</a></span><span class="op">(</span><span class="va">dt.sim.noid</span>,<span class="va">covs</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##      data nrows ncols</span></span>
<span><span class="co">##    &lt;char&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">## 1:    dt1   195    13</span></span>
<span><span class="co">## 2:    dt2    10    10</span></span>
<span><span class="co">## 3: result  1950    23</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### same thing, the data.table way</span></span>
<span><span class="co">## dt.sim.covs &lt;- covs[,dt.sim.noid[],by=covs]</span></span>
<span><span class="co">### same thing, dplyr way</span></span>
<span><span class="co">## dt.sim.covs &lt;- dplyr::select(dt.sim,-ID) |&gt;</span></span>
<span><span class="co">##   cross_join(covs)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dt.sim.covs</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.typ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dt.sim.covs</span>,</span>
<span>                name.sim<span class="op">=</span><span class="st">"singlesubj_covs"</span>,</span>
<span>                table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span><span class="op">)</span>,</span>
<span>                typical<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>                as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.typ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_singlesubj_covs_MetaData.rds"</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">simres.ref</span> <span class="op">&lt;-</span> <span class="va">simres.typ</span><span class="op">[</span><span class="va">type</span><span class="op">==</span><span class="st">"ref"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">all.plots</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">simres.typ</span><span class="op">[</span><span class="va">type</span><span class="op">==</span><span class="st">"value"</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"covvar"</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span></span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>            <span class="va">covvar.this</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">covvar</span><span class="op">)</span><span class="op">]</span></span>
<span>            <span class="va">simres.ref</span><span class="op">[</span>,<span class="va">covvalc</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">covvar.this</span><span class="op">)</span>,<span class="st">"(Reference)"</span><span class="op">)</span><span class="op">]</span></span>
<span>            <span class="va">all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">x</span>,<span class="va">simres.ref</span><span class="op">)</span></span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">all</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TAPD</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">covvalc</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">}</span><span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">period</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu">patchwork</span><span class="fu">::</span><span class="fu"><a href="https://patchwork.data-imaginist.com/reference/wrap_plots.html" class="external-link">wrap_plots</a></span><span class="op">(</span><span class="va">all.plots</span>,ncol<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-forest_files/figure-html/plot-singlesubjs-1.png" width="672"></p>
</details>
</div>
</div>
<div class="section level2">
<h2 id="simulation-with-parameter-uncertainty">Simulation With Parameter Uncertainty<a class="anchor" aria-label="anchor" href="#simulation-with-parameter-uncertainty"></a>
</h2>
<p>We need to run the simulations repeatedly, sampling parameters based
on uncertainty estimates. This can be done in various ways. First of
all, one must choose between non-parametric and parametric sampling.
Non-parameteric sampling is typically based on a bootstrap, and the
parametetric sampling is often based on a successfull
<code>$COVARIANCE</code> step. <code>NMsim</code> has methods to do
either type, and multiple methods are available for parametric sampling.
The best source of information on these different methods is the
ACOP2024 poster <a href="../reference/figures/NMsim_param_uncertainty_web.pdf">Simulation
of clinical trial predictions with model uncertainty using NMsim</a> by
Sanaya Shroff and Philip Delff.</p>
<p>In this case we shall use parametric sampling, relying on a Nonmem
<code>$COVARIANCE</code> step. Since in this case we are simulating
typical subjects (random effects fixed at zero), we only need
variability on the fixed effects (THETA’s). Multiple methods are
available in <code>NMsim</code> to do this. We use
<code>NMsim_NWPRI</code> - which automates simulation using the Nonmem
NWPRI subroutine to sample the parameter sets. This simulation method
excels in being fast to execute because it simulates all the parameter
sets sequentially in one Nonmem run. It is important to run this with
<code>typical=TRUE</code>. If between-subject variability is desired,
please refer to <a href="https://NMautoverse.github.io/NMsim/articles/NMsim-ParamUncertain.html"><code>NMsim-ParamUncertain.html</code></a>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.forest.nwpri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span> <span class="co"># path to NONMEM model</span></span>
<span>                            ,data<span class="op">=</span><span class="va">dt.sim.covs</span>, <span class="co"># simulation dataset</span></span>
<span>                            ,name.sim<span class="op">=</span><span class="st">"nwpri_forest"</span> <span class="co"># output name suffix</span></span>
<span>                            ,method.sim<span class="op">=</span><span class="va">NMsim_NWPRI</span> <span class="co"># sampling with NWPRI</span></span>
<span>                            ,subproblems<span class="op">=</span><span class="fl">1000</span> <span class="co">## number of parameter sets sampled</span></span>
<span>                            ,typical<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># FALSE to include BSV</span></span>
<span>                            ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span> <span class="co"># output table variables</span></span>
<span>                            ,seed.R<span class="op">=</span><span class="fl">342</span> <span class="co"># seed for reproducibility</span></span>
<span>                             <span class="op">)</span></span></code></pre></div>

<p>If you encounter issues with samples that do not run, consider
whether any of your uncertainty estimates on <code>THETA</code>’s could
lead to sampled <code>THETA</code>’s that could make the model be
undefined. This would often be absorption parameters, clearences,
volumes or any other strictly positive parameter which is estimated with
poor precision. If this happens, you may want to go back and estimate
that <code>THETA</code> on the log scale to make sure all sampled values
will be positive.</p>
<details><summary>
Show example
</summary><p>A quick way to look for this is by combining parameter estimates
(from the <code>.ext</code> file) and the automatic labeling of the
parameters using <code><a href="https://nmautoverse.github.io/NMdata/reference/NMrelate.html" class="external-link">NMdata::NMrelate()</a></code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">file.mod</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span><span class="va">par.type</span><span class="op">==</span><span class="st">"THETA"</span>,<span class="fu">.</span><span class="op">(</span>RSE<span class="op">=</span><span class="va">se</span><span class="op">/</span><span class="va">value</span><span class="op">)</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">FIX</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="fu">NMdata</span><span class="fu">::</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMrelate.html" class="external-link">NMrelate</a></span><span class="op">(</span><span class="va">file.mod</span>,par.type<span class="op">=</span><span class="st">"THETA"</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">par.name</span>,<span class="va">code</span><span class="op">)</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"par.name"</span>,quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr class="header">
<th align="left">par.name</th>
<th align="right">FIX</th>
<th align="right">RSE</th>
<th align="left">code</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">THETA(1)</td>
<td align="right">0</td>
<td align="right">0.0804007</td>
<td align="left">LTVKA=THETA(1)</td>
</tr>
<tr class="even">
<td align="left">THETA(2)</td>
<td align="right">0</td>
<td align="right">0.0136327</td>
<td align="left">LTVV2=THETA(2)</td>
</tr>
<tr class="odd">
<td align="left">THETA(3)</td>
<td align="right">0</td>
<td align="right">0.0789812</td>
<td align="left">LTVCL=THETA(3)</td>
</tr>
<tr class="even">
<td align="left">THETA(4)</td>
<td align="right">0</td>
<td align="right">0.0481949</td>
<td align="left">LTVV3=THETA(4)</td>
</tr>
<tr class="odd">
<td align="left">THETA(5)</td>
<td align="right">0</td>
<td align="right">0.0292952</td>
<td align="left">LTVQ=THETA(5)</td>
</tr>
<tr class="even">
<td align="left">THETA(6)</td>
<td align="right">0</td>
<td align="right">0.4222300</td>
<td align="left">AGEEFF=THETA(6)</td>
</tr>
<tr class="odd">
<td align="left">THETA(7)</td>
<td align="right">0</td>
<td align="right">1.9160784</td>
<td align="left">WEIGHTEFF=THETA(7)</td>
</tr>
<tr class="even">
<td align="left">THETA(8)</td>
<td align="right">0</td>
<td align="right">0.1041536</td>
<td align="left">MALEEFF=THETA(8)</td>
</tr>
</tbody>
</table>
</div>
<p>A large RSE is a potential issue for strictly positive parameters
(RSE=0.25 for a parameter with a positive estimate corresponds to
roughly 1/10,000 chance that a sample is negative). In this case,
<code>THETA</code>s are estimated on log scale, and the covariate
effects could be negative, so this model does not seem to have such
issues.</p>
</details>
</div>
<div class="section level2">
<h2 id="post-processing">Post processing<a class="anchor" aria-label="anchor" href="#post-processing"></a>
</h2>
<p><code>NMsim</code> provides a function to do the post processing of
the set of simulations setup by <code><a href="../reference/forestDefineCovs.html">forestDefineCovs()</a></code>. The key
steps performed by this function are outlined below. Most importantly,
it normalizes the exposures by the reference value for each sampled set
of parameters. Then, it derives median and a confidence interval as
quantiles in the simulated distribution.</p>
<p>The step required by the user is to define the functions to derive
relevant exposure metrics. We will use AUC 0-24h and Cmax. We are using
<code>IPRED</code> for the calculations. Notice, the simulation was run
with <code>typical=TRUE</code> so <code>PRED</code> and
<code>IPRED</code> should be the same. However, with depending on the
Nonmem version, <code>NWPRI</code> works a little differently, and
<code>IPRED</code> has to be used prior to Nonmem 7.6.0.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### Define exposure metrics</span></span>
<span><span class="va">funs.exposure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="st">"Cmax"</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">IPRED</span><span class="op">)</span></span>
<span>   ,<span class="st">"AUC"</span><span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/trapez.html" class="external-link">trapez</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">TIME</span>,<span class="va">x</span><span class="op">$</span><span class="va">IPRED</span><span class="op">)</span></span>
<span>    <span class="co">## ,"Concentration at 4 hours"=function(x) x$value[x$TAPD==4]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forestSummarize.html">forestSummarize</a></span><span class="op">(</span><span class="va">simres</span>,</span>
<span>                                 funs.exposure <span class="op">=</span> <span class="va">funs.exposure</span>,</span>
<span>                                 by<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>,</span>
<span>                                 cover.ci<span class="op">=</span><span class="fl">.95</span></span>
<span>                                 <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">)</span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">covlabel</span><span class="op">==</span><span class="st">"Bodyweigt (kg)"</span>,<span class="va">covlabel</span><span class="op">:=</span><span class="st">"Bodyweight (kg)"</span><span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="plotting">Plotting<a class="anchor" aria-label="anchor" href="#plotting"></a>
</h2>
<p>We will use the R package <code>coveffectsplot</code> for plotting.
<code><a href="https://smouksassi.github.io/coveffectsplot/reference/forest_plot.html" class="external-link">coveffectsplot::forest_plot()</a></code> requires certain column names
so we adjust those first. An acceptance region such as the 80%-125% bio
equivalence is included.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setDT.html" class="external-link">setDT</a></span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">sum.uncertain</span>,</span>
<span>         <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">covvalf</span>,<span class="va">predmm</span>,<span class="va">predml</span>,<span class="va">predmu</span>,<span class="va">metric.var</span><span class="op">)</span>,</span>
<span>         <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">label</span>,<span class="va">mid</span>,<span class="va">lower</span>,<span class="va">upper</span>,<span class="va">paramname</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">MEANVAL</span><span class="op">:=</span><span class="va">mid</span><span class="op">]</span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">covname</span><span class="op">:=</span><span class="va">covlabel</span><span class="op">]</span></span>
<span><span class="va">nsig</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="va">sum.uncertain</span><span class="op">[</span>,<span class="va">LABEL</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s [%s - %s]"</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">mid</span>,<span class="va">nsig</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">lower</span>,<span class="va">nsig</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/signif2.html" class="external-link">signif2</a></span><span class="op">(</span><span class="va">upper</span>,<span class="va">nsig</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="va">descrip.legend</span> <span class="op">&lt;-</span> <span class="st">"Reference (vertical line)\nClinically relevant limits 0.8-1.25 (colored area)"</span></span>
<span></span>
<span><span class="co">### I don't know why forest_plot() needs this </span></span>
<span><span class="va">label_value</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,<span class="va">...</span> <span class="op">)</span><span class="va">x</span></span>
<span></span>
<span><span class="va">fun.plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>,<span class="va">...</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">textsize</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span>    <span class="va">forest1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://smouksassi.github.io/coveffectsplot/reference/forest_plot.html" class="external-link">forest_plot</a></span><span class="op">(</span></span>
<span>        data <span class="op">=</span> <span class="va">data</span>,</span>
<span>        facet_formula <span class="op">=</span> <span class="st">"covlabel ~ paramname"</span>, </span>
<span>        facet_scales <span class="op">=</span> <span class="st">"free_y"</span>,</span>
<span>        facet_space <span class="op">=</span> <span class="st">"free_y"</span>,</span>
<span>        xy_facet_text_bold <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>        plot_table_ratio <span class="op">=</span> <span class="fl">1.7</span>, </span>
<span>        table_text_size <span class="op">=</span> <span class="fl">3</span>,</span>
<span>        x_label_text_size <span class="op">=</span> <span class="va">textsize</span>,</span>
<span>        y_label_text_size <span class="op">=</span> <span class="va">textsize</span>, </span>
<span>        x_facet_text_size <span class="op">=</span> <span class="va">textsize</span>, </span>
<span>        y_facet_text_size <span class="op">=</span> <span class="va">textsize</span>,</span>
<span>        base_size<span class="op">=</span><span class="va">textsize</span>,</span>
<span>        strip_placement <span class="op">=</span> <span class="st">"outside"</span>,</span>
<span>        table_position <span class="op">=</span> <span class="st">"right"</span>,</span>
<span>        legend_order <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pointinterval"</span>, <span class="st">"ref"</span>, <span class="st">"area"</span><span class="op">)</span>,</span>
<span>        x_range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span>,<span class="fl">1.5</span><span class="op">)</span>,</span>
<span>        ref_legend_text <span class="op">=</span> <span class="va">descrip.legend</span>,</span>
<span>        area_legend_text <span class="op">=</span> <span class="va">descrip.legend</span>,</span>
<span>        facet_switch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"y"</span><span class="op">)</span>,</span>
<span>        legend_position<span class="op">=</span><span class="st">"bottom"</span>,</span>
<span>        <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">forest.day1</span> <span class="op">&lt;-</span> <span class="fu">fun.plot</span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">period</span><span class="op">==</span><span class="st">"Day 1"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-forest_files/figure-html/plot1-1.png" width="960"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">forest.ss</span> <span class="op">&lt;-</span> <span class="fu">fun.plot</span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">period</span><span class="op">==</span><span class="st">"Steady-State"</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<p><img src="NMsim-forest_files/figure-html/plot1-2.png" width="960"></p>
<details><summary>
Simulation using multivariate normal distribution
</summary><p>We shall use the method provided by NMsim based on the multivariate
normal distribution (<code>mvrnorm</code>). This method is selected
because it is adequate for sampling <code>THETA</code>’s, it does not
require additional software installed, other than Nonmem.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ext.mvrnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/samplePars.html">samplePars</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,nsim<span class="op">=</span><span class="fl">1000</span>,method<span class="op">=</span><span class="st">"mvrnorm"</span>,seed.R<span class="op">=</span><span class="fl">6789</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres.forest.mvrnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span> <span class="co"># path to NONMEM model</span></span>
<span>                              ,data<span class="op">=</span><span class="va">dt.sim.covs</span>, <span class="co"># simulation dataset</span></span>
<span>                              ,name.sim<span class="op">=</span><span class="st">"mvrnorm_forest"</span> <span class="co"># output name suffix</span></span>
<span>                              ,method.sim<span class="op">=</span><span class="va">NMsim_VarCov</span> <span class="co"># sampling with mvrnorm</span></span>
<span>                              ,ext<span class="op">=</span><span class="va">ext.mvrnorm</span></span>
<span>                              ,typical<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># FALSE to include BSV</span></span>
<span>                              ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span> <span class="co"># output table variables</span></span>
<span>                              ,seed.R<span class="op">=</span><span class="fl">342</span> <span class="co"># seed for reproducibility</span></span>
<span>                              ,sge<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># TRUE if submitting to a cluster</span></span>
<span>                              ,nc<span class="op">=</span><span class="fl">1</span></span>
<span>                               <span class="op">)</span></span></code></pre></div>
</details><details><summary>
Simulation using simpar for parameter sampling
</summary><div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ext.simpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/samplePars.html">samplePars</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,nsim<span class="op">=</span><span class="fl">1000</span>,method<span class="op">=</span><span class="st">"simpar"</span>,seed.R<span class="op">=</span><span class="fl">789</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres.forest.simpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span> <span class="co"># path to NONMEM model</span></span>
<span>                             ,data<span class="op">=</span><span class="va">dt.sim.covs</span>, <span class="co"># simulation dataset</span></span>
<span>                             ,name.sim<span class="op">=</span><span class="st">"simpar_forest"</span> <span class="co"># output name suffix</span></span>
<span>                             ,method.sim<span class="op">=</span><span class="va">NMsim_VarCov</span> <span class="co"># sampling with mvrnorm</span></span>
<span>                             ,ext<span class="op">=</span><span class="va">ext.simpar</span></span>
<span>                             ,typical<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># FALSE to include BSV</span></span>
<span>                             ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span> <span class="co"># output table variables</span></span>
<span>                             ,seed.R<span class="op">=</span><span class="fl">342</span> <span class="co"># seed for reproducibility</span></span>
<span>                             ,sge<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># TRUE if submitting to a cluster</span></span>
<span>                             ,nc<span class="op">=</span><span class="fl">1</span></span>
<span>                              <span class="op">)</span></span></code></pre></div>
</details><details><summary>
Simulation using bootstrap for parameter sampling
</summary><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dir.bs</span> <span class="op">&lt;-</span> <span class="st">"NMsim-forest-models/xgxr134_bs_N1000/m1"</span></span>
<span><span class="va">exts.bs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">list.files</a></span><span class="op">(</span><span class="va">dir.bs</span>,pattern<span class="op">=</span><span class="st">".+\\.ext$"</span>,recursive<span class="op">=</span><span class="cn">T</span>,full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">ext.boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadExt.html" class="external-link">NMreadExt</a></span><span class="op">(</span><span class="va">exts.bs</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">simres.forest.boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span> <span class="co"># path to NONMEM model</span></span>
<span>                           ,data<span class="op">=</span><span class="va">dt.sim.covs</span>, <span class="co"># simulation dataset</span></span>
<span>                           ,name.sim<span class="op">=</span><span class="st">"boot_forest"</span> <span class="co"># output name suffix</span></span>
<span>                           ,method.sim<span class="op">=</span><span class="va">NMsim_VarCov</span> <span class="co"># sampling with mvrnorm</span></span>
<span>                           ,ext<span class="op">=</span><span class="va">ext.boot</span></span>
<span>                           ,typical<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># FALSE to include BSV</span></span>
<span>                           ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span> <span class="co"># output table variables</span></span>
<span>                           ,seed.R<span class="op">=</span><span class="fl">342</span> <span class="co"># seed for reproducibility</span></span>
<span>                           ,sge<span class="op">=</span><span class="cn">TRUE</span> <span class="co"># TRUE if submitting to a cluster</span></span>
<span>                           ,nc<span class="op">=</span><span class="fl">1</span></span>
<span>                            <span class="op">)</span></span></code></pre></div>
</details><div class="section level3">
<h3 id="comparison-of-different-simulation-methods">Comparison of different simulation methods<a class="anchor" aria-label="anchor" href="#comparison-of-different-simulation-methods"></a>
</h3>
<p>The forest were simulated with all the methods mentioned above. As
expected, the forest plots are very similar for NWPRI, mvrnorm, and
simpar. This is expected because they all sample THETAs from the
multivariate normal distribution. Among these, <code>NMsim_NWPRI</code>
is the fasted to execute. A bootstrap may be desired or needed for a
non-parametric approach. Remember that this is a very simple model, and
similarities in the results based on the parametric models and bootstrap
cannot be generalized based on this.</p>
<details><summary>
Collecting, Summarizing, and Plotting all Results
</summary><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.forest.nwpri</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_nwpri_forest_MetaData.rds"</span><span class="op">)</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">simres.forest.mvrnorm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_mvrnorm_forest_MetaData.rds"</span><span class="op">)</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">simres.forest.simpar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_simpar_forest_MetaData.rds"</span><span class="op">)</span>,wait<span class="op">=</span><span class="cn">TRUE</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">simres.forest.boot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"simres-forest/xgxr134_boot_forest_MetaData.rds"</span><span class="op">)</span>,wait<span class="op">=</span><span class="cn">T</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">simres.forest.all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simres.forest.nwpri</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"NWPRI"</span><span class="op">]</span>,</span>
<span>                           <span class="va">simres.forest.mvrnorm</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"mvrnorm"</span><span class="op">]</span>,</span>
<span>                           <span class="va">simres.forest.boot</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"Bootstrap"</span><span class="op">]</span></span>
<span>                          ,<span class="va">simres.forest.simpar</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"Simpar"</span><span class="op">]</span></span>
<span>                          ,fill<span class="op">=</span><span class="cn">T</span></span>
<span>                           <span class="op">)</span></span>
<span></span>
<span><span class="co">### How many samples used with each method?</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">simres.forest.all</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">method</span>,<span class="va">model.sim</span>,<span class="va">NMREP</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">[</span>,<span class="va">.N</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">method</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr class="header">
<th align="left">method</th>
<th align="right">N</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">NWPRI</td>
<td align="right">1000</td>
</tr>
<tr class="even">
<td align="left">mvrnorm</td>
<td align="right">1000</td>
</tr>
<tr class="odd">
<td align="left">Bootstrap</td>
<td align="right">1000</td>
</tr>
<tr class="even">
<td align="left">Simpar</td>
<td align="right">1000</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/forestSummarize.html">forestSummarize</a></span><span class="op">(</span><span class="va">simres.forest.all</span>,</span>
<span>                                 funs.exposure <span class="op">=</span> <span class="va">funs.exposure</span>,</span>
<span>                                 by<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">method</span>,<span class="va">period</span><span class="op">)</span>,</span>
<span>                                 cover.ci<span class="op">=</span><span class="fl">.95</span>,</span>
<span>                                 as.fun<span class="op">=</span><span class="st">"data.table"</span></span>
<span>                                 <span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot.compare</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sum.uncertain</span><span class="op">[</span><span class="va">period</span><span class="op">==</span><span class="st">"Steady-State"</span><span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">predmm</span>,<span class="va">covvalf</span>,colour<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin<span class="op">=</span><span class="fl">.8</span>,xmax<span class="op">=</span><span class="fl">1.2</span>,ymin<span class="op">=</span><span class="op">-</span><span class="cn">Inf</span>,ymax<span class="op">=</span><span class="cn">Inf</span>,colour<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span>,fill<span class="op">=</span><span class="st">"grey85"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin<span class="op">=</span><span class="va">predml</span>,xmax<span class="op">=</span><span class="va">predmu</span>,ymin<span class="op">=</span><span class="va">covvalf</span>,ymax<span class="op">=</span><span class="va">covvalf</span><span class="op">)</span>,</span>
<span>              position<span class="op">=</span><span class="fu">ggstance</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggstance/man/position-vertical.html" class="external-link">position_dodgev</a></span><span class="op">(</span>height<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>position<span class="op">=</span><span class="fu">ggstance</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ggstance/man/position-vertical.html" class="external-link">position_dodgev</a></span><span class="op">(</span>height<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">covlabel</span><span class="op">~</span><span class="va">metric.var</span>,scales<span class="op">=</span><span class="st">"free_y"</span>,switch<span class="op">=</span><span class="st">"y"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">1</span>,linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y<span class="op">=</span><span class="st">""</span>,x<span class="op">=</span><span class="st">"Relative Covariate Effect"</span>,colour<span class="op">=</span><span class="st">"Simulation Method"</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span></span></code></pre></div>
</details><p><img src="NMsim-forest_files/figure-html/show-plot-compare-1.png" width="672"></p>
</div>
</div>
<div class="section level2">
<h2 id="post-processing-step-by-step">Post-processing step-by-step<a class="anchor" aria-label="anchor" href="#post-processing-step-by-step"></a>
</h2>
<p>We are including the code from the main steps in the post processing
function, <code><a href="../reference/forestSummarize.html">NMsim::forestSummarize()</a></code>. It is important that
the scientist understands that what the forest plots derived in this
document represent is the relative effect of the covariate on the
exposure metric. This is derived by
<code><a href="../reference/forestSummarize.html">NMsim::forestSummarize()</a></code> as quantiles of the exposure
relative to the reference subject. The confidence interval hence
expresses the uncertainty on the covariate effect for a subject with
other covariates at reference values.</p>
<details><summary>
Details on code used for summarizing forest plot statistics (click to
show)
</summary><p>Notice, the code below consists of snippets from the
<code><a href="../reference/forestSummarize.html">NMsim::forestSummarize()</a></code> function. The code is not intended
to be used on its own.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### use only simulated samples</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span></span>
<span><span class="co">### summarizing exposure metrics for each subject in each model,</span></span>
<span><span class="co">### each combination of covariates</span></span>
<span><span class="va">resp.model</span> <span class="op">&lt;-</span> <span class="va">simres</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">funs.exposure</span>,<span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="fu">f</span><span class="op">(</span><span class="va">.SD</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                     by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">allby</span>,<span class="va">modelby</span>,<span class="st">"ID"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### the exposure metrics in long format.</span></span>
<span><span class="va">mvars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">funs.exposure</span><span class="op">)</span></span>
<span><span class="va">resp.model.l</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">resp.model</span>,measure.vars<span class="op">=</span><span class="va">mvars</span>,variable.name<span class="op">=</span><span class="st">"metric.var"</span>,value.name<span class="op">=</span><span class="st">"metric.val"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## deriving median by model and time to have a single value per</span></span>
<span><span class="co">## model This is only relevant in case multiple subjects are</span></span>
<span><span class="co">## simulated by each model. </span></span>
<span><span class="va">sum.res.model</span> <span class="op">&lt;-</span> <span class="va">resp.model.l</span><span class="op">[</span></span>
<span>   ,<span class="fu">.</span><span class="op">(</span>predm<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">metric.val</span><span class="op">)</span><span class="op">)</span></span>
<span>   ,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">modelby</span>,<span class="va">allby</span>,<span class="st">"metric.var"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="co">### making reference value a column rather than rows. </span></span>
<span><span class="co">## column with refrence exposure value is called val.exp.ref</span></span>
<span></span>
<span><span class="co">### summarize distribution of ratio to ref across parameter samples/models</span></span>
<span><span class="va">sum.uncertain</span> <span class="op">&lt;-</span> <span class="va">sum.res.model</span><span class="op">[</span></span>
<span>   ,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">predm</span><span class="op">/</span><span class="va">val.exp.ref</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">cover.ci</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">.5</span>,<span class="fl">1</span><span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">cover.ci</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"predml"</span>,<span class="st">"predmm"</span>,<span class="st">"predmu"</span><span class="op">)</span><span class="op">)</span></span>
<span>   ,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">allby</span>,<span class="st">"metric.var"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
