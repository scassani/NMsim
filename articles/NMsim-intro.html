<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMsim - Seamless NONMEM Simulation Platform in R • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="NMsim - Seamless NONMEM Simulation Platform in R">
<meta name="google-site-verification" content="-8n-8OfzJii_lVruWfxXOhzUATKSgMdiSxMhOQoscu4">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Data Set Creation with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NMsim - Seamless NONMEM Simulation Platform in R</h1>
                        <h4 data-toc-skip class="author">Philip
Delff</h4>
                        
            <h4 data-toc-skip class="date">May 21, 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-intro.Rmd" class="external-link"><code>vignettes/NMsim-intro.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-intro.Rmd</code></div>
    </div>

    
    
<style type="text/css">

body{
  font-size: 12pt;
}

h1.title {
  font-size: 24px;
  color: DarkRed;
  margin-top: 2em;
  margin-bottom: 1em;
}
h1 { /* Header 1 */
  font-size: 20px;
  color: DarkBlue;
}
h2 { /* Header 2 */
  margin-top: 1em;
  font-size: 20px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
h4 { /* Header 4 */
  font-size: 16px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
table.Rtable1 {
    font-size: 12px;
}

.superbigimage{
      overflow-x:scroll;
      white-space: nowrap;
  }

.superbigimage img{
     max-width: none;
  }
  
h4.author {
  font-weight:bold;
  font-style:italic;
  margin-top: 0em;
  margin-bottom: 1em;
}
h4.date {
  font-weight:bold;
  margin-top: 0em;
  margin-bottom: 5em;
}


/* -----------div tips------------- */

div.summary {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #bed3ec;
 border: solid 5px #dfedff;
 /* background-image: url("Summary_ffffff.png"); */
}

div.data {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #FAD07D;
 border: solid 5px #FFDE9C;
 /* background-image: url("Stats graph_ffffff.png"); */
}


/* ----------- code fold button ------------- */
.showopt {
  display:inline-block;
  width: 120px;
  height: 29px;
  text-align: center;
  font-weight:400;
  vertical-align: middle !important;
  float: right;
  font-family: sans-serif;
  border-radius: 8px;
  cursor: pointer;
  border-color: #adb1b8 #a2a6ac #8d9096;
  border-style: solid;
  box-shadow: rgba(255,255,255,.6) 0 1px 0 inset;
  background-image:none;
}

pre{
  width:100%;
}




</style>
<p><img src="../reference/figures/NMsimlogo240.png" alt="NMsim" style="width:200px; float:right;"></p>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<p>This introduction to NMsim aims at enabling NONMEM users to</p>
<ul>
<li>Configure NMsim to find your NONMEM installation</li>
<li>Set up a simulation data set and simulate a NONMEM model using that
data set</li>
<li>Simulate a typical subject</li>
<li>Simulate multiple models and compare them</li>
<li>Simulate observed or previously simulated subjects based on
emperical Bayes estimates (ETA’s)</li>
<li>Simulate multiple subjects with covariate sampling and generation of
prediction intervals</li>
</ul>
</div>
<div class="section level2">
<h2 id="configuration">Configuration<a class="anchor" aria-label="anchor" href="#configuration"></a>
</h2>
<p>NMsim must be configured with the path to the NONMEM executable. This
can be done for each <code><a href="../reference/NMsim.html">NMsim()</a></code> call using the
<code>path.nonmem</code> argument, but more easily it can be configured
globally the following way. Also including where NMsim will run NONMEM
and store intermediate files (<code>dir.sims</code>) and where to store
final results (<code>dir.res</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://nmautoverse.github.io/NMdata/" class="external-link">NMdata</a></span><span class="op">)</span></span>
<span><span class="co">## Point NMsim to your NONMEM exectuable - looks like this on linux/osx</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>path.nonmem <span class="op">=</span> <span class="st">"/opt/NONMEM/nm75/run/nmfe75"</span><span class="op">)</span></span>
<span><span class="co">## or on Windows, it could be</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>path.nonmem <span class="op">=</span> <span class="st">"c:/nm75g64/run/nmfe75.bat"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMdataConf.html" class="external-link">NMdataConf</a></span><span class="op">(</span>dir.sims<span class="op">=</span><span class="st">"simtmp-intro"</span>, <span class="co">## location of sim tmp files</span></span>
<span>           dir.res<span class="op">=</span><span class="st">"simres-intro"</span><span class="op">)</span>  <span class="co">## location of sim results</span></span></code></pre></div>
<p>For more information on this and how to test the configuration, see
<a href="https://NMautoverse.github.io/NMsim/articles/NMsim-config.html"><code>NMsim-config.html</code></a>.</p>
</div>
<div class="section level2">
<h2 id="a-first-simulation-with-nmsim">A first simulation with <code>NMsim()</code><a class="anchor" aria-label="anchor" href="#a-first-simulation-with-nmsim"></a>
</h2>
<p>When providing a simulation data set, the default
<code><a href="../reference/NMsim.html">NMsim()</a></code> behavior is to sample a new subject (ETA’s).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Point to the model to estimate</span></span>
<span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,</span>
<span>                        package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="co">## Easily create a muliple-dose simulation data set with a loading dose</span></span>
<span><span class="va">data.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,ADDL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,II<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">## Simulate</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,data<span class="op">=</span><span class="va">data.sim</span>,table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The simulation input data set is a data.frame, and
<code><a href="../reference/NMsim.html">NMsim()</a></code> returns a data.frame. Plot of simulation results
(click to button show code):</p>
<div class="fold s">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt</a></span><span class="op">(</span>measure.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">datl</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">value</span>,colour<span class="op">=</span><span class="va">variable</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">!=</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="va">x</span><span class="op">[</span><span class="va">variable</span><span class="op">==</span><span class="st">"Y"</span><span class="op">]</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span>,</span>
<span>         subtitle<span class="op">=</span><span class="st">"Simulation of one new subject."</span>,</span>
<span>         colour<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/simple-sim-showplot-1.png" alt="`PRED`, `IPRED`, and `Y` (if defined in control stream) are easily obtained with NMsim." width="100%"><p class="caption">
<code>PRED</code>, <code>IPRED</code>, and <code>Y</code> (if defined in
control stream) are easily obtained with NMsim.
</p>
</div>
<p>Notice that no information about the model is needed except for the
control stream file path. The simulation is based on evaluation of
<code>PRED</code>, <code>IPRED</code>, and optionally <code>Y</code>.
Options exist for building more advanced simulation models. The models
shown here are based on data available in the <a href="https://cran.r-project.org/package=xgxr" class="external-link"><code>xgxr</code></a>.</p>
</div>
<div class="section level2">
<h2 id="simulation-data-sets">Simulation data sets<a class="anchor" aria-label="anchor" href="#simulation-data-sets"></a>
</h2>
<p>The input data is a data.frame that</p>
<ul>
<li>Must contain at least the variables NONMEM will need to run the
model (typically <code>ID</code>, <code>CMT</code>, <code>AMT</code>,
etc. plus covariates)</li>
<li>Can contain character variables (automatically carried to
results)</li>
<li>Column order does not matter</li>
</ul>
<p>As long as those requirements are met, there are no requirements to
how the data sets are created. So if you already have a prefered way to
do this, that’s fine. NMsim provides convenient helper functions that
can optionally be used. <code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code> creates just the
dosing events, and <code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> adds the sampling events.
By default, doses are indicated using <code>EVID=1</code> and samples by
<code>EVID=2</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,</span>
<span>                       addl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ADDL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,II<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">doses</span>,TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>Notice, <code><a href="../reference/NMcreateDoses.html">NMcreateDoses()</a></code> has many flexible and convenient
features. See <code><a href="../reference/NMcreateDoses.html">?NMcreateDoses</a></code> and the vignette ond creating
simulation data sets for more.</p>
<details><summary>
Additional <code>NMcreateDoses()</code> examples
</summary><div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## arguments are expanded - makes loading easy</span></span>
<span><span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span>,<span class="fl">24</span>,<span class="fl">36</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr>
<th style="text-align:right;">
ID
</th>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
EVID
</th>
<th style="text-align:right;">
CMT
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
MDV
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
36
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Different doses by covariate</span></span>
<span><span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">2</span><span class="op">)</span>,DOSE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr>
<th style="text-align:right;">
ID
</th>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
EVID
</th>
<th style="text-align:right;">
CMT
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
MDV
</th>
<th style="text-align:right;">
DOSE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
</tbody>
</table>
</div>
</details><div class="section level4">
<h4 id="adding-sampling-times">Adding sampling times<a class="anchor" aria-label="anchor" href="#adding-sampling-times"></a>
</h4>
<p>For adding sampling times to a set of doses and/or samples,
<code><a href="../reference/NMaddSamples.html">NMaddSamples()</a></code> provides a similarly flexible interface. It
accepts data.frames with covariates allowing for different sampling
schemes for different subject groups (say different dosing regimens),
and dosing times can be supplied relative to previous dosing times.</p>
<details><summary>
Additional <code>NMaddSamples()</code> examples
</summary><div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## a dosing data set with two doses</span></span>
<span><span class="va">dt.dos</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">12</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sampling based on time since previous dose</span></span>
<span><span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">dt.dos</span>,TAPD<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr>
<th style="text-align:right;">
ID
</th>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
EVID
</th>
<th style="text-align:right;">
CMT
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
MDV
</th>
<th style="text-align:right;">
TAPD
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## TIME and TAPD can be combined - adding a follow-up</span></span>
<span><span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">dt.dos</span>,TAPD<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,TIME<span class="op">=</span><span class="fl">96</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr>
<th style="text-align:right;">
ID
</th>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
EVID
</th>
<th style="text-align:right;">
CMT
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
MDV
</th>
<th style="text-align:right;">
TAPD
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
96
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## sampling two compartments - naming them</span></span>
<span><span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">dt.dos</span>,TAPD<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,CMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>CMT<span class="op">=</span><span class="fl">2</span><span class="op">:</span><span class="fl">3</span>,DVID<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Parent"</span>,<span class="st">"Metabolite"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="kable-table">
<table class="table">
<thead><tr>
<th style="text-align:right;">
ID
</th>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
EVID
</th>
<th style="text-align:right;">
CMT
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
MDV
</th>
<th style="text-align:right;">
TAPD
</th>
<th style="text-align:left;">
DVID
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Parent
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Metabolite
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Parent
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Metabolite
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
12
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Parent
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
13
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:left;">
Metabolite
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Parent
</td>
</tr>
<tr>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
14
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:left;">
Metabolite
</td>
</tr>
</tbody>
</table>
</div>
</details>
</div>
<div class="section level4">
<h4 id="time-since-previous-dose">Time since previous dose<a class="anchor" aria-label="anchor" href="#time-since-previous-dose"></a>
</h4>
<p>While not used in these examples, it’s worth mentioning
<code><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">NMdata::addTAPD()</a></code> for adding time since previous dose and
other variables related to previous dose - previous dosing time,
previous dose amount, cumulative number of doses, cumulative number of
doses, and culative dose amount. These are often useful to add to a
simulation dataset:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">addTAPD</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="check-the-simulation-dataset">Check the simulation dataset<a class="anchor" aria-label="anchor" href="#check-the-simulation-dataset"></a>
</h4>
<p>A quick way to check for a lot of common issues in a NONMEM data set
is running <code><a href="https://nmautoverse.github.io/NMdata/reference/NMcheckData.html" class="external-link">NMcheckData()</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMcheckData.html" class="external-link">NMcheckData</a></span><span class="op">(</span><span class="va">dat.sim</span>,type.data<span class="op">=</span><span class="st">"sim"</span><span class="op">)</span></span></code></pre></div>
<p>It is also advised to plot the simulation data set. See <a href="NMsim-DataCreate.html">Creation of Simulation Data Sets</a> for
more details.</p>
</div>
</div>
<div class="section level2">
<h2 id="typical-subject-simulation">Typical subject simulation<a class="anchor" aria-label="anchor" href="#typical-subject-simulation"></a>
</h2>
<ul>
<li>A typical subject is a subject with all ETAs = 0</li>
<li>Covariates values are supplied using the simulation input data
set</li>
<li>
<code>typical=TRUE</code>: replace all <code>$OMEGA</code> values
with zeros</li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.typ</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                    typical<span class="op">=</span><span class="cn">TRUE</span>,  <span class="co">## FIX all OMEGA's to zero</span></span>
<span>                    name.sim<span class="op">=</span><span class="st">"typical"</span>, <span class="co">## simulation name - included in output</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="simulate-multiple-models">Simulate multiple models<a class="anchor" aria-label="anchor" href="#simulate-multiple-models"></a>
</h2>
<p>Multiple models can be simulated using the same data set in one
function call by supplying more than one model in the
<code>file.mod</code> argument. The models can be simulated on multiple
data sets by submitting a list of data.frames in the <code>data</code>
argument. NMsim will return one data.frame with all the results for easy
post-processing.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file2.mod</span> <span class="op">&lt;-</span> <span class="st">"models/xgxr114.mod"</span></span>
<span><span class="va">simres.typ2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2 compartments"</span><span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                                <span class="st">"1 compartment"</span><span class="op">=</span><span class="va">file2.mod</span><span class="op">)</span>,</span>
<span>                     data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                     typical<span class="op">=</span><span class="cn">TRUE</span>, <span class="co">## FIX all OMEGA's to zero</span></span>
<span>                     table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span></span>
<span>                     <span class="op">)</span></span>
<span><span class="co">## The "model" column is used to distinguish the two models</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">simres.typ2</span>,<span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/two-models-1.png" alt="Simulation of multiple models and even multiple data sets is handled within one `NMsim()` call." width="100%"><p class="caption">
Simulation of multiple models and even multiple data sets is handled
within one <code><a href="../reference/NMsim.html">NMsim()</a></code> call.
</p>
</div>
</div>
<div class="section level2">
<h2 id="emperical-bayes-estimates-known-etas">Emperical Bayes’ Estimates (known ETAs)<a class="anchor" aria-label="anchor" href="#emperical-bayes-estimates-known-etas"></a>
</h2>
<p>Reusing ETA’s is enabled using the <code>NMsim_EBE</code> method.</p>
<ul>
<li>By default, automatically re-uses estimated individual ETAs</li>
<li>ID values in simulation data must match the ID values in the
estimation that you want to simulate</li>
<li>Other ETA sources (<code>.phi</code> files) can be specified</li>
<li>Does not simulate residual variability - see
<code><a href="../reference/addResVar.html">addResVar()</a></code> if needed</li>
<li>Remember: Covariates may be needed in data set to fully reproduce
the subjects’ parameters</li>
</ul>
<p>In the following, we use <code>table.vars</code> to specify variables
to output in NONMEM’s <code>$TABLE</code> section. In this case, we do
that to make sure we get <code>CL</code> and <code>V2</code>. But
generally, <code>table.vars</code> is very important to know as the very
first thing to do to speed up <code><a href="../reference/NMsim.html">NMsim()</a></code>. This is because
NONMEM often takes much longer writing the output table than it does
doing the actual simulation. So it is recommended to specify a slim
output table using something like
<code>table.vars=c("PRED","IPRED","Y")</code> and other variables you
may need from NONMEM. Notice <code>NMsim</code> knows how to combine
output table data with the simulation input data, so you do not need
variables like <code>ID</code> or <code>TIME</code> in
<code>table.vars</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## this example uses the same sim data for all subjects</span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">T</span><span class="op">)</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">ID</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">]</span></span>
<span><span class="va">data.sim.ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.sim</span>,select<span class="op">=</span><span class="op">-</span><span class="va">ID</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ID<span class="op">=</span><span class="va">ids</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">data.sim.ind</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="va">simres.ebe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                    data<span class="op">=</span><span class="va">data.sim.ind</span>,</span>
<span>                    table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"CL"</span>,<span class="st">"V2"</span>,<span class="st">"IPRED"</span>,<span class="st">"PRED"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/unnamed-chunk-6-1.png" alt="Individual parameters are confirmed to be identical in estimation results and simulation results" width="100%"><p class="caption">
Individual parameters are confirmed to be identical in estimation
results and simulation results
</p>
</div>
</div>
<div class="section level2">
<h2 id="prediction-intervals">Prediction intervals<a class="anchor" aria-label="anchor" href="#prediction-intervals"></a>
</h2>
<p>New subjects can be simulated in multiple ways with NMsim.</p>
<ul>
<li>If the input data set contains multiple subjects, these subjects
will get separate random effects due to NONMEM
<code>$SIMULATION</code>
</li>
<li>The <code>subproblems</code> argument translates to the
<code>SUBPROBLEMS</code> NONMEM subroutine, replicating the simulation
the specified number of times with new seeds</li>
<li>The <code><a href="../reference/simPopEtas.html">simPopEtas()</a></code> function can generate a synthetic .phi
file with a simulated population that can be reused in future
<code><a href="../reference/NMsim.html">NMsim()</a></code> calls. This can be combined with simulation of
covariates in R, allowing reuse of the same subjects across multiple
simulations.</li>
</ul>
<p>In the following we use both of these approaches to simulate 1000 new
subjects. We use <code><a href="../reference/NMsim.html">NMsim()</a></code>’s <code>name.sim</code> argument
to distinguish the simulation in output data and simulation output
files.</p>
<ul>
<li>Simulate 1000 new subjects using <code>$SUBPROBLEMS</code>
</li>
</ul>
<div class="fold s">
<p>Notice the following reuses the input data set 1000 times, and a
column called <code>NMREP</code> will count the subproblem number in the
output.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tablevars</span><span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">Y</span><span class="op">)</span></span>
<span><span class="va">simres.subprob</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"Subproblems"</span>, <span class="co">## naming the simulation</span></span>
<span>                        subproblems<span class="op">=</span><span class="fl">1000</span>,  <span class="co">## Will become SUPROBLEMS=1000 in NONMEM</span></span>
<span>                        table.vars<span class="op">=</span><span class="va">tablevars</span>,</span>
<span>                        seed.R<span class="op">=</span><span class="fl">764</span>, <span class="co">## NMsim() will set the R seed for reproducibility</span></span>
<span>                        reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
<p>To generate a prediction interval, this format is sufficient. If you
want to distinguish the subjects, you can update the <code>ID</code>
column to reflect unique combinations of <code>ID</code> and
<code>NMREP</code>. With <code>data.table</code>, this can be done this
way:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## data.table:</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.subprob</span><span class="op">)</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">NMREP</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">## dplyr:</span></span>
<span><span class="va">simres.subprob</span> <span class="op">&lt;-</span> <span class="va">simres.subprob</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">group_by</span><span class="op">(</span><span class="va">NMREP</span>,<span class="va">ID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">mutate</span><span class="op">(</span>ID <span class="op">=</span> <span class="fu">cur_group_id</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>By the way, if you would like <code><a href="../reference/NMsim.html">NMsim()</a></code> to return
<code>data.table</code> objects, just run
<code>NMdataConf(as.fun="data.table")</code>. If you want tibbles, run
<code>NMdataConf(as.fun=tibble::as_tibble)</code>.</p>
</div>
<ul>
<li>Simulate 1000 new subjects with covariate sampling</li>
</ul>
<div class="fold s">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Replicating input data set allows for manual resampling of covariates.</span></span>
<span></span>
<span><span class="co">## NMdata::findCovs() extracts unique values of column that do not vary within `by`. Since `by` is here the subject ID, that means we are finding subject level and globally equal variables only.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2372</span><span class="op">)</span></span>
<span><span class="va">Nsubjs</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span><span class="va">dt.ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ID<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="va">Nsubjs</span><span class="op">)</span></span>
<span><span class="va">dt.covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMscanData.html" class="external-link">NMscanData</a></span><span class="op">(</span><span class="va">file.mod</span>,quiet<span class="op">=</span><span class="cn">T</span>,as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/findCovs.html" class="external-link">findCovs</a></span><span class="op">(</span>by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ID"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dt.ids</span><span class="op">[</span>,<span class="va">IDEST</span><span class="op">:=</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">dt.covs</span><span class="op">[</span>,<span class="va">ID</span><span class="op">]</span>,size<span class="op">=</span><span class="va">.N</span>,replace<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">dt.ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="va">dt.ids</span>,<span class="va">dt.covs</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>IDEST<span class="op">=</span><span class="va">ID</span>,<span class="va">WEIGHTB</span>,trt<span class="op">=</span><span class="va">trtact</span><span class="op">)</span><span class="op">]</span>,by<span class="op">=</span><span class="st">"IDEST"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## This is data.table-style repeating `data.sim` without `ID` for each</span></span>
<span><span class="co">## row in dt.ids. This is an outer join, or a cartesian product. I</span></span>
<span><span class="co">## think in dplyr, one can use `crossing` to get this.</span></span>
<span><span class="va">data.sim.nsubjs</span> <span class="op">&lt;-</span> <span class="va">dt.ids</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data.sim</span>,select<span class="op">=</span><span class="op">-</span><span class="va">ID</span><span class="op">)</span>,by<span class="op">=</span><span class="va">dt.ids</span><span class="op">]</span></span>
<span><span class="co">## see, we repeated one data set using the other</span></span>
<span><span class="co">## dims(data.sim,dt.ids,data.sim.nsubjs)</span></span>
<span></span>
<span><span class="co">## generate the population first, by simulating etas to use in the sim</span></span>
<span><span class="fu"><a href="../reference/simPopEtas.html">simPopEtas</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,N<span class="op">=</span><span class="fl">1000</span>,seed<span class="op">=</span><span class="fl">1231</span>,</span>
<span>           file.phi<span class="op">=</span><span class="st">"simres-intro/xgxr021_1000subjs.phi"</span><span class="op">)</span></span>
<span><span class="va">simres.datarep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                        data<span class="op">=</span><span class="va">data.sim.nsubjs</span>,</span>
<span>                        name.sim<span class="op">=</span><span class="st">"Individual simulation data"</span>,</span>
<span>                        table.vars<span class="op">=</span><span class="va">tablevars</span>,</span>
<span>                        seed.nm<span class="op">=</span><span class="fl">103</span>,</span>
<span>                        method.sim<span class="op">=</span><span class="va">NMsim_EBE</span>,</span>
<span>                        file.phi<span class="op">=</span><span class="st">"simres-intro/xgxr021_1000subjs.phi"</span>,</span>
<span>                        reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>                        <span class="op">)</span></span></code></pre></div>
</div>
<ul>
<li>Derive and plot 90% prediction intervals</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Collect and stack simulation results </span></span>
<span><span class="va">simres.newpops</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.subprob</span><span class="op">)</span>,</span>
<span>                        <span class="va">simres.datarep</span>,fill<span class="op">=</span><span class="cn">T</span><span class="op">)</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## Derive prediction intervals - notice name.sim distincts results from the two methods</span></span>
<span><span class="va">simres.pi</span> <span class="op">&lt;-</span> <span class="va">simres.newpops</span><span class="op">[</span></span>
<span>   ,<span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">IPRED</span>,probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.05</span>,<span class="fl">.5</span>,<span class="fl">.95</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">ll</span>,<span class="va">median</span>,<span class="va">ul</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">name.sim</span>,<span class="va">trt</span>,<span class="va">TIME</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">label.pi</span> <span class="op">&lt;-</span> <span class="st">"90% Prediction interval"</span></span>
<span><span class="va">simres.pi</span><span class="op">$</span><span class="va">type</span> <span class="op">&lt;-</span> <span class="va">label.pi</span></span>
<span></span>
<span><span class="va">p.pi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.pi</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,fill<span class="op">=</span><span class="va">type</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">ll</span>,ymax<span class="op">=</span><span class="va">ul</span><span class="op">)</span>,alpha<span class="op">=</span><span class="fl">.4</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>,linetype<span class="op">=</span><span class="st">"Median"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_alpha_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.5</span><span class="op">)</span>,<span class="va">label.pi</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_linetype_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,<span class="st">"Median"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">name.sim</span><span class="op">)</span><span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Hours since first dose"</span>,y<span class="op">=</span><span class="st">"Concentration (ng/mL)"</span>,colour<span class="op">=</span><span class="st">""</span>,linetype<span class="op">=</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-intro_files/figure-html/pred-inds-showplot-1.png" alt="Prediction intervals. New subjects can be simulated in multiple ways with NMsim. A simulated population can be reused across simulations." width="100%"><p class="caption">
Prediction intervals. New subjects can be simulated in multiple ways
with NMsim. A simulated population can be reused across simulations.
</p>
</div>
</div>
<div class="section level2">
<h2 id="read-previously-generated-simulations">Read previously generated simulations<a class="anchor" aria-label="anchor" href="#read-previously-generated-simulations"></a>
</h2>
<p>There is no need to save simulation results because they are already
saved by <code>NMsim</code>. Instead, use arguments
<code>dir.sims</code>, <code>dir.res</code> and <code>name.sim</code> to
make sure to get a meaningful structure for the generated files. Then
read the results with <code><a href="../reference/NMreadSim.html">NMreadSim()</a></code>. To re-read the first
simulation we did in this article, we can do this:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="st">"simres-intro/xgxr021_noname_MetaData.rds"</span><span class="op">)</span></span></code></pre></div>
<p>The folder and file names were constructed based on
<code>dir.res="simres-intro"</code> and because <code>name.sim</code>
was not provided for that first simulation, in which case “noname” is
used as a placeholder. In fact, if we look at the console output from
NMsim, it is telling us exactly that (look at the last line).</p>
<p>Click to show R console output from NMsim</p>
<div class="fold o">
<pre><code>&gt; simres &lt;- NMsim(file.mod=file.mod,data=data.sim)
Location(s) of intermediate files and Nonmem execution:
  simtmp-intro/xgxr021_noname
Location of final result files:
  simres-intro

* Writing simulation control stream(s) and simulation data set(s)
* Executing Nonmem job(s) 
Starting NMTRAN

(...)

Done with nonmem execution
* Collecting Nonmem results

Simulation results returned. Re-read them without re-simulating using:
  simres &lt;- NMreadSim("simres-intro/xgxr021_noname_MetaData.rds")
</code></pre>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
