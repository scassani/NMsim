<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMsim - Seamless NONMEM Simulation Platform in R • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="NMsim - Seamless NONMEM Simulation Platform in R">
<meta name="google-site-verification" content="-8n-8OfzJii_lVruWfxXOhzUATKSgMdiSxMhOQoscu4">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Data Set Creation with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NMsim - Seamless NONMEM Simulation Platform in R</h1>
                        <h4 data-toc-skip class="author">Philip
Delff</h4>
                                    <h4 data-toc-skip class="author">Simone
Cassani</h4>
                        
            <h4 data-toc-skip class="date">May 23, 2025</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-modify-model.Rmd" class="external-link"><code>vignettes/NMsim-modify-model.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-modify-model.Rmd</code></div>
    </div>

    
    
<style type="text/css">

body{
  font-size: 12pt;
}

h1.title {
  font-size: 24px;
  color: DarkRed;
  margin-top: 2em;
  margin-bottom: 1em;
}
h1 { /* Header 1 */
  font-size: 20px;
  color: DarkBlue;
}
h2 { /* Header 2 */
  margin-top: 1em;
  font-size: 20px;
  color: DarkBlue;
}
h3 { /* Header 3 */
  font-size: 18px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
h4 { /* Header 4 */
  font-size: 16px;
  font-family: "Times New Roman", Times, serif;
  color: DarkBlue;
}
table.Rtable1 {
    font-size: 12px;
}

.superbigimage{
      overflow-x:scroll;
      white-space: nowrap;
  }

.superbigimage img{
     max-width: none;
  }
  
h4.author {
  font-weight:bold;
  font-style:italic;
  margin-top: 0em;
  margin-bottom: 1em;
}
h4.date {
  font-weight:bold;
  margin-top: 0em;
  margin-bottom: 5em;
}


/* -----------div tips------------- */

div.summary {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #bed3ec;
 border: solid 5px #dfedff;
 /* background-image: url("Summary_ffffff.png"); */
}

div.data {
 padding: 1em;
 margin: 1em;
 padding-left: 50px;
 background-size: 30px;
 background-repeat: no-repeat;
 background-position: 10px 10px;
 min-height: 40px;
 font-size: 16px;
 color: #000000;
 background-color: #FAD07D;
 border: solid 5px #FFDE9C;
 /* background-image: url("Stats graph_ffffff.png"); */
}

</style>
<!-- <img src="../reference/figures/NMsimlogo.png" alt="Logo" style="width:200px; float:right;"> --><div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette introduce the <code>NMsim</code> feature that allows
users to specify modifications to a <code>NONMEM</code> model. The
NONMEM control stream can be edited directly from within the
<code>NMsim</code> function call in the <code>R</code> script via the
flexible interface provided by the argument <code>modify.model</code>.
The edits can be applied to any section of the control stream, and most
commonly they will affect the <code>$PK</code> or <code>$PRED</code>
sections, or even the <code>$DES</code> or <code>$MODEL</code> sections
when needed. Note that, since the data related sections
(<code>$INPUT</code>,<code>$DATA</code>,<code>$TABLE</code>) are
automatically handled by NMsim, it will be rarely necessary that they
are edited via the <code>modify.model</code> argument. Additionally the
<code>NMsim</code> function has specific arguments regarding the
<code>$TABLE</code> sections, namely <code>table.vars</code> and
<code>table.options</code>.</p>
<p>Notice, until NMsim 0.1.0, the <code>modify.model</code> argument was
called <code>list.sections</code>, and it was characterized by a
different formatting and level of flexibility. The helper functions
<code>add</code> and <code>overwrite</code> were introduced with NMsim
0.1.3, to add and overwrite control stream lines, respectively. Until
then, custom modification functions had to be provided like described in
the section “Edit control stream using customized functions’.</p>
<p>This vignette illustrates some examples and applications of the use
of the <code>modify.model</code> argument.</p>
<p>An initial configuration, described in the Introductory NMsim
vignette <strong>add_link</strong>, might be necessary for the correct
functioning of the NMsim library.</p>
</div>
<div class="section level2">
<h2 id="objectives">Objectives<a class="anchor" aria-label="anchor" href="#objectives"></a>
</h2>
<!-- DONE --- Philip comments:
The introduction can be clearer. I would say we can assume the reader is familiar with basic use of NMsim at this point. A prerequisite section can even lay that out, and that can be the NMsim-intro vignette.
This vignette rather allows NMsim user to specify modifications to nonmem models to be simulated. The current wording "run a model" is technically correct but for now, I think we should just focus on simulation, so I would use that verb rather than "run". 
"This option" is not clear. The modfify.model argument  should probably be very briefly introduced, maybe in an "Introduction" section before this. It is a flexible interface to edit the control stream before simulation. -->
<p>The examples described below use the <code>modify.model</code>
argument to modify the NONMEM control stream and to address the
following pharmacometric questions:</p>
<!-- DONE --- Philip comments :
The examples are great. This is the "Objectives" section. So maybe before each question, say what is done, like: 
Modify KA: How is the conc-time profile.....? -->
<ul>
<li>Modify <code>KA</code>: How is the concentration-time profile
affected if switching formulation (reducing absorption rate) by a range
of fold-values?</li>
<li>Modify <code>F1</code> and <code>CL</code>: What is the expected
concentration-time profile in patients with a certain Drug-Drug
Interaction effect on clearance and bioavailability?</li>
<li>Add <code>ALAG</code>: How will a dose delay of different amounts of
time affect the predicted exposure?</li>
<li>Add AUC computation in control stream: How can we use NONMEM to
integrate AUC during model simulation leveraging the benefits of using a
sparse grid via <code>NMsim</code>?</li>
</ul>
<!-- DONE --- Philip comment: This wording can be clearer. Use nonmem to integrate AUC, with benefit that a sparse simulation grid can be used? --><!-- REMOVED # Variable Parameters --><!-- DONE Philip comment:
The first part of this section could be elaborated a little and be called "Introduction" and put before the "objectives". list.sections is not formatted the same way as modify.model.  --><!-- modify.model is a flexible interface that allows for modification of control stream sections before a simulation is performed. modify.model can be used to edit any section in a control stream but most commonly, this would be the $PK or $PRED section, or it could be $DES and $MODEL if needed. --><!-- Remember that data related sections like $INPUT, $DATA, and $TABLE are automatically handled by NMsim, and it should not be necessary to consider those. For the $TABLE section specifically, look at the `table.vars` and `table.options` arguments instead. --><!-- MOVED TO INMTRODUCTION :Sometimes we want to simulate with some modification to the estimated model. NMsim canmake such user-specified modifications to the model before simulating through the `modify.model` argument.
Notice, until NMsim 0.1.0, the `modify.model` argument was called `list.sections`. The helper functions `add` and `overwrite` were introduced with NMsim 0.1.3. Until then, custom modification functions had to be provided like described in the section "Edit control stream using customized functions." --><!-- # Configuration --><!-- DONE : Philip comment:
None of these configurations are specific to using the modify.model argument. In a prerequisites section, you can mention that the user may need to config a little (as described in te intro vignette) and then you can omit this section. --><!-- REFERENCED in INTRO and removed from here --- NMsim must be configured with the path to the NONMEM executable. This can be done for each `NMsim()` call using the `path.nonmem` argument, but more easily it can be configured globally the following way. Also including where NMsim will run NONMEM and store intermediate files (`dir.sims`) and where to store final results (`dir.res`). --><!-- ```{r,echo=TRUE,eval=FALSE} --><!-- library(NMdata) --><!-- library(NMsim) --><!-- ## Point NMsim to your NONMEM exectuable - looks like this on linux/osx --><!-- NMdataConf(path.nonmem = "/opt/NONMEM/nm75/run/nmfe75") --><!-- ## or on Windows, it could be --><!-- NMdataConf(path.nonmem = "c:/nm75g64/run/nmfe75.bat") --><!-- NMdataConf(dir.sims="simtmp-modify", ## location of sim tmp files --><!--            dir.res="simres-modify", --><!--            as.fun="data.table")  ## location of sim results --><!-- ``` -->
</div>
<div class="section level2">
<h2 id="change-in-formulation-example-">Change in formulation Example.<a class="anchor" aria-label="anchor" href="#change-in-formulation-example-"></a>
</h2>
<!-- Philip comment:
I wrote the following as I was going through the doc. After having read the DDI example too, I actually really like this. But maybe in the intro and/or the first line of the examples, we should add what this illustrates in terms of NMsim features. 
The section title can be improved to match the learning objective. I agree its good to "flavor" with interpretation and communicate potential uses of these features. But I'd suggest to move that into the text.
Suggest: "Modify parameter values by editing the $PK section"-->
<p>The effect on the concentration-time profile of a change in
formulation that reduces absorption rate <code>KA</code> is explored
with the use of a scaling factor <code>KASCALE=c(1,4,10)</code> included
to the NONMEM control stream via the <code>modify.model</code> argument.
The absorption rate reduction is provided through the <code>NMsim</code>
simulation data <code>dat.sim.varka</code> containing dosing events,
simulation time steps and the value of <code>KASCALE</code> for each
simulated patient.</p>
<p>First <code>KASCALE</code> is added to the simulation data</p>
<!-- Philip comment: remove unused code -->
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr021.mod"</span>,</span>
<span>                        package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="va">data.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadCsv.html" class="external-link">NMreadCsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/derived/dat_sim1.csv"</span>,</span>
<span>                                 package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#data.sim=setDT(data.sim)</span></span>
<span><span class="co"># add KASCALE and copy patient info for each value of KASCALE</span></span>
<span><span class="va">dat.sim.varka</span> <span class="op">&lt;-</span> <span class="va">data.sim</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>KASCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">4</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">data.sim</span><span class="op">]</span> </span>
<span><span class="va">dat.sim.varka</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">KASCALE</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span> <span class="co"># update patient IDs</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.varka</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span> <span class="co"># order rows</span></span></code></pre></div>
<p>Then the <code>NMsim</code> function is used to run the simulation in
which the <code>modify.model</code> argument is used to simulate a
modified model with different absorption rates, scaled by the parameter
<code>KASCALE</code>. Two different approaches are demonstrated:</p>
<ol style="list-style-type: lower-alpha">
<li>the effect of the scaling factor <code>KASCALE</code> is added at
the end of the <code>PK</code> section in the NONMEM control
stream.</li>
</ol>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.varka</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span> <span class="co"># NONMEM control stream</span></span>
<span>          ,data<span class="op">=</span><span class="va">dat.sim.varka</span> <span class="co"># simulation data file</span></span>
<span>          ,name.sim<span class="op">=</span><span class="st">"varka"</span></span>
<span>          ,modify.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"KA=KA/KASCALE"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: lower-alpha">
<li>the specific line that defines <code>TVKA</code> is modified to
include the effect of the scaling factor <code>KASCALE</code>
</li>
</ol>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.varka2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>          ,data<span class="op">=</span><span class="va">dat.sim.varka</span></span>
<span>          ,name.sim<span class="op">=</span><span class="st">"varka2"</span></span>
<span>          ,modify.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/overwrite.html">overwrite</a></span><span class="op">(</span><span class="st">"THETA(1)"</span>,<span class="st">"THETA(1)/KASCALE"</span><span class="op">)</span><span class="op">)</span></span>
<span>          <span class="op">)</span></span></code></pre></div>
<p>The code below returns the plot</p>
<!-- Philip comment:
This is really nice. 
I suggest
- comment on the strengths and weaknesses of add and overwrite. I think typically, most users should use "add" because it's simpler. "add" is really simple but it can only patch after the rest of PK has already been processed. If something in PK is derived from the variables being modified, it will not work. "overwrite" is the CAS9 approach which can be very powerful and suffers from off-target risk. And also, the code needed may be more specific to a model. In this example, overwrite refers to THETA(1) which is model specific. add referring to KA only may be more generic. 
It would be very good to include some diffr() snippets to show what happened to the PK sections. If the PK section is simple, NMreadSection(sim.mod,section="PK") may be sufficient. sim.mod should be the generated simulation control streams. You may be able to run it on all of the control streams (the estimated, and the two simulated) at once, put it into a data.table, and show the control stream lines side by side as a table. -->
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.varka</span><span class="op">=</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.varka</span><span class="op">)</span></span>
<span><span class="va">simres.varka2</span><span class="op">=</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">simres.varka2</span><span class="op">)</span></span>
<span><span class="va">simres.both</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">simres.varka</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"a. add()"</span><span class="op">]</span>,</span>
<span>                     <span class="va">simres.varka2</span><span class="op">[</span>,<span class="va">method</span><span class="op">:=</span><span class="st">"b. custom/sub()"</span><span class="op">]</span></span>
<span>                     <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">simres.both</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span><span class="op">]</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">KASCALE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"Fold absorption prolongation, KASCALE"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">168</span>,by<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/varka-sim-plot-1.png" alt="Concentration (`PRED`) profile as a function of time computed by `NMsim` modified models **a** (left) and **b** (right). The equivalence and robustness of the two modified models is supported by the matching results, corresponding to reduced `PRED` values for higher values of `KASCALE` (lower absorption rate)." width="100%"><p class="caption">
Concentration (<code>PRED</code>) profile as a function of time computed
by <code>NMsim</code> modified models <strong>a</strong> (left) and
<strong>b</strong> (right). The equivalence and robustness of the two
modified models is supported by the matching results, corresponding to
reduced <code>PRED</code> values for higher values of
<code>KASCALE</code> (lower absorption rate).
</p>
</div>
<p>NOTE: the NMsim <code>overwrite</code> function prior to version
0.1.6 has a bug that was fixed in the0.1.5.902 github release; it can be
installed with</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://remotes.r-lib.org" class="external-link">remotes</a></span><span class="op">)</span></span>
<span><span class="fu">install_github</span><span class="op">(</span><span class="st">"NMautoverse/NMsim"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="drug-drug-interaction-ddi">Drug-Drug Interaction (DDI)<a class="anchor" aria-label="anchor" href="#drug-drug-interaction-ddi"></a>
</h2>
The effect of DDI on clearance (<code>CL</code>) and bioavailability
(<code>F1</code>) is simulated for the following scenarios
<table class="table">
<thead><tr>
<th style="text-align:left;">
scenario
</th>
<th style="text-align:left;">
CLSCALE
</th>
<th style="text-align:left;">
FSCALE
</th>
<th style="text-align:left;">
CLSCALE/FSCALE
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;">
noDDI
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
1
</td>
</tr>
<tr>
<td style="text-align:left;">
DDI.1
</td>
<td style="text-align:left;">
0.5
</td>
<td style="text-align:left;">
1.2
</td>
<td style="text-align:left;">
0.42
</td>
</tr>
<tr>
<td style="text-align:left;">
DDI.2
</td>
<td style="text-align:left;">
0.33
</td>
<td style="text-align:left;">
1.1
</td>
<td style="text-align:left;">
0.3
</td>
</tr>
</tbody>
</table>
<p>First the <code>CL</code> and <code>F1</code> data is added to the
patient data</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## 'Outer join'</span></span>
<span><span class="va">dat.sim.DDI</span><span class="op">=</span><span class="va">data.sim</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>CLSCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">/</span><span class="fl">3</span><span class="op">)</span></span>
<span>                                ,FSCALE<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1.2</span>,<span class="fl">1.1</span><span class="op">)</span></span>
<span>                                ,lab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"noDDI"</span>,<span class="st">"DDI.1"</span>,<span class="st">"DDI.2"</span><span class="op">)</span><span class="op">)</span></span>
<span>                    ,by<span class="op">=</span><span class="va">data.sim</span><span class="op">]</span></span>
<span><span class="va">dat.sim.DDI</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">lab</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.DDI</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span></code></pre></div>
<p>Then, the DDI driven change in parameters is added at the end of the
PK section of the NONMEM control stream via the
<code>modify.model</code> argument in the <code><a href="../reference/NMsim.html">NMsim()</a></code>
function.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.DDI</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>            ,data<span class="op">=</span><span class="va">dat.sim.DDI</span></span>
<span>            ,name.sim<span class="op">=</span><span class="st">"DDI"</span></span>
<span>            ,modify.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"CL=CL*CLSCALE"</span></span>
<span>                                      ,<span class="st">"F1=FSCALE"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The effect on the concentration-time profile is shown in the figure
below</p>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-11-1.png" alt="Concentration (`PRED`) profile as a function of time computed by `NMsim` modified model for different DDIs. The modified model correctly simulates (i) a higher value of `Cmax` on day 1 for higher biovalability; (ii) a higher `PRED` value  at steady state for lower apparent clearance effect `CLSCALE/FSCALE` values." width="100%"><p class="caption">
Concentration (<code>PRED</code>) profile as a function of time computed
by <code>NMsim</code> modified model for different DDIs. The modified
model correctly simulates (i) a higher value of <code>Cmax</code> on day
1 for higher biovalability; (ii) a higher <code>PRED</code> value at
steady state for lower apparent clearance effect
<code>CLSCALE/FSCALE</code> values.
</p>
</div>
</div>
<div class="section level2">
<h2 id="dose-delay">Dose delay<a class="anchor" aria-label="anchor" href="#dose-delay"></a>
</h2>
<!-- Philip comment: A little more intro would be useful. What are you simulating, and how are you doing that? The current wording aims at the ladder, but it is very technical - even I have to read it slowly to follow. -->
<!-- Philip comment: we should explain that we could set up different simulation data sets to obtain this. I mean by delaying the dose in the data set. But we are showing this to illustrate the flexibility of these features. In practice, many users might - with good reason - prefer to edit the time column in the sim data sets. -->
<p>Deviations in the administration schedule of a drug are simulated
including three parameters in the dataset: the dose number
<code>DOSCUMN</code>, obtained with <code><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">NMdata::addTAPD()</a></code>, the
specific number of the delayed dose <code>DELAYDOS</code> and the time
delay <code>ALAG</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dat.sim.alag</span> <span class="op">=</span> <span class="va">data.sim</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMexpandDoses.html" class="external-link">NMexpandDoses</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/addTAPD.html" class="external-link">addTAPD</a></span><span class="op">(</span><span class="op">)</span> <span class="co"># expand doses and add dose number</span></span>
<span><span class="va">dat.sim.alag</span><span class="op">[</span>,<span class="va">ROW</span><span class="op">:=</span><span class="va">.I</span><span class="op">]</span> <span class="co"># restore ROW with correct value</span></span>
<span><span class="co"># add delayed dose</span></span>
<span><span class="va">dat.sim.dos.delay</span><span class="op">=</span><span class="va">dat.sim.alag</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>DELAYDOS<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">4</span>,<span class="fl">5</span>,<span class="fl">6</span>,<span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>                                ,by<span class="op">=</span><span class="va">dat.sim.alag</span><span class="op">]</span></span>
<span><span class="co"># add dose delay </span></span>
<span><span class="va">dat.sim.alag.final</span><span class="op">=</span><span class="va">dat.sim.dos.delay</span><span class="op">[</span>,<span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>ALAG<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">6</span>,<span class="fl">12</span>,<span class="fl">18</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span></span>
<span>                                     ,by<span class="op">=</span><span class="va">dat.sim.dos.delay</span><span class="op">]</span></span>
<span><span class="co"># update ID </span></span>
<span><span class="va">dat.sim.alag.final</span><span class="op">[</span>,<span class="va">ID</span><span class="op">:=</span><span class="va">.GRP</span>,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ALAG</span>,<span class="va">DELAYDOS</span>,<span class="va">ID</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">dat.sim.alag.final</span>,<span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">EVID</span><span class="op">)</span></span>
<span><span class="co">#dat.sim.alag.final = dat.sim.alag.final |&gt; fill(DOSCUMN)</span></span></code></pre></div>
<p>The following patient has a 6 hours delay to the administration of
dose 2.</p>
<table class="table">
<thead><tr>
<th style="text-align:right;">
TIME
</th>
<th style="text-align:right;">
AMT
</th>
<th style="text-align:right;">
DOSCUMN
</th>
<th style="text-align:right;">
DELAYDOS
</th>
<th style="text-align:right;">
ALAG
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:right;">
0
</td>
<td style="text-align:right;">
300
</td>
<td style="text-align:right;">
1
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
24
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
48
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
3
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
72
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
4
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
96
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
5
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
120
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
6
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
<tr>
<td style="text-align:right;">
144
</td>
<td style="text-align:right;">
150
</td>
<td style="text-align:right;">
7
</td>
<td style="text-align:right;">
2
</td>
<td style="text-align:right;">
6
</td>
</tr>
</tbody>
</table>
<p>The time delay is included in the modified control stream with
<code>NMsim</code> adding a single line at the end of the PK section,
where the dose delay on compartment 1 <code>ALAG1</code> is modified for
the dose with dose number <code>DOSCUMN</code> equal to the target
delayed dose number <code>DELAYDOS</code></p>
<!-- Philip comment: This explanation is easier to follow than the first one -->
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres.alag</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span></span>
<span>              ,data<span class="op">=</span><span class="va">dat.sim.alag.final</span></span>
<span>              ,name.sim<span class="op">=</span><span class="st">"alag"</span></span>
<span>              ,modify.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>PK<span class="op">=</span></span>
<span>                    <span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"IF(DOSCUMN.EQ.DELAYDOS) ALAG1=ALAG"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The effect on concentration-time profiles and daily AUC are shown in
the two images below.</p>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-16-1.png" alt="Effect of time delay (0, 12 and 24 hours on dose 2) on concentration (`PRED`) profile as a function of time computed by `NMsim` modified model. The implementation of the modified model simply consists of the addition of the variables `DOSCUMN`, `DELAYDOS`, and `ALAG` to the original data set, and the addition of one line of code to the PK section of the control stream via `modify.model`." width="100%"><p class="caption">
Effect of time delay (0, 12 and 24 hours on dose 2) on concentration
(<code>PRED</code>) profile as a function of time computed by
<code>NMsim</code> modified model. The implementation of the modified
model simply consists of the addition of the variables
<code>DOSCUMN</code>, <code>DELAYDOS</code>, and <code>ALAG</code> to
the original data set, and the addition of one line of code to the PK
section of the control stream via <code>modify.model</code>.
</p>
</div>
<!-- Philip comment: The AUC vs dose delay needs a little explanation. I think the intro to the dose delay example should explain we want to study the effect of delaying doses on predicted exposure. And then also just a sentence or two before this plot. -->
<!-- Philip comment would be good to include AUC/cmax derivation as folded code. -->
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-17-1.png" alt="Daily exposure on day 3 as a function of time delay for dose 2 (left) and dose 3 (right). The simulation results predict an increased risk for possible safety concerns (left panel, over-exposure) and loss of efficacy (right panel, under-exposure) as dose time delay gets larger." width="100%"><p class="caption">
Daily exposure on day 3 as a function of time delay for dose 2 (left)
and dose 3 (right). The simulation results predict an increased risk for
possible safety concerns (left panel, over-exposure) and loss of
efficacy (right panel, under-exposure) as dose time delay gets larger.
</p>
</div>
</div>
<div class="section level2">
<h2 id="auc">AUC<a class="anchor" aria-label="anchor" href="#auc"></a>
</h2>
<!-- Philip comment: A little more intro would be helpful. This is a more advanced example that modifies multiple sections. -->
<p>The following example computes daily exposure:</p>
<ul>
<li>at post-processing, using trapezoidal method, after the unmodified
NONMEM model is simulated on three different fine grids with evenly
spaced time steps of <code>0.25</code>, <code>1</code>, and
<code>4</code> hours, respectively, labelled <strong>AUC
trapez</strong>
</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file.mod.auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/nonmem/xgxr046.mod"</span>,</span>
<span>                        package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span></span>
<span><span class="va">data.sim.auc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/NMreadCsv.html" class="external-link">NMreadCsv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"examples/derived/dat_sim1.csv"</span>,</span>
<span>                                 package<span class="op">=</span><span class="st">"NMsim"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.auc</span><span class="op">[</span>,<span class="va">AMT</span><span class="op">:=</span><span class="fl">1000</span><span class="op">*</span><span class="va">AMT</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># time step 1hr</span></span>
<span><span class="va">data.sim.1hr</span><span class="op">=</span><span class="va">data.sim.auc</span></span>
<span><span class="va">data.sim.1hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"1hr"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># time step 0.25hr</span></span>
<span><span class="va">data.sim.0.25hr</span><span class="op">=</span><span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">192</span>,by<span class="op">=</span><span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.0.25hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"0.25hr"</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># time step 4hr</span></span>
<span><span class="va">data.sim.4hr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">192</span>,by<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">data.sim.4hr</span><span class="op">[</span>,<span class="va">TSTEP</span><span class="op">:=</span><span class="st">"4hr"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">sres.trapez</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod.auc</span></span>
<span>      ,data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">data.sim.1hr</span> <span class="co"># run NMsim on a list of data sets to run all different scenarios at once</span></span>
<span>                 ,<span class="va">data.sim.0.25hr</span></span>
<span>                 ,<span class="va">data.sim.4hr</span><span class="op">)</span></span>
<span>      ,seed<span class="op">=</span><span class="fl">12345</span></span>
<span>      ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span><span class="op">)</span></span>
<span>      ,name.sim<span class="op">=</span><span class="st">"AUC.trapez"</span></span>
<span>      ,reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span><span class="co"># daily AUC computation</span></span>
<span><span class="va">sim.auc</span><span class="op">=</span><span class="va">sres.trapez</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">2</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">TIME</span>,<span class="va">PRED</span>,time.step<span class="op">=</span><span class="va">TSTEP</span><span class="op">)</span><span class="op">]</span> </span>
<span><span class="va">sim.auc</span><span class="op">[</span>,<span class="va">DAY</span><span class="op">:=</span><span class="op">(</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span><span class="fl">24</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="co"># define DAY variable</span></span>
<span><span class="co"># create duplicate time steps for end-of-day</span></span>
<span><span class="co"># (e.g 24h belongs to both day 1 and day2)</span></span>
<span><span class="va">sim.dupli.24h</span><span class="op">=</span><span class="va">sim.auc</span><span class="op">[</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span><span class="fl">24</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">TIME</span><span class="op">&gt;</span><span class="fl">0</span>,<span class="fu">.</span><span class="op">(</span><span class="va">ID</span></span>
<span>                                             ,DAY<span class="op">=</span><span class="va">DAY</span><span class="op">-</span><span class="fl">1</span></span>
<span>                                             ,<span class="va">TIME</span></span>
<span>                                             ,<span class="va">PRED</span></span>
<span>                                             ,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sim.auc.final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">sim.auc</span></span>
<span>                       ,<span class="va">sim.dupli.24h</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setorder.html" class="external-link">setorder</a></span><span class="op">(</span><span class="va">ID</span>,<span class="va">DAY</span>,<span class="va">TIME</span>,<span class="va">time.step</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sim.auc.trapez</span><span class="op">&lt;-</span><span class="va">sim.auc.final</span><span class="op">[</span><span class="va">DAY</span><span class="op">&lt;</span><span class="fl">8</span>,<span class="fu">.</span><span class="op">(</span>AUC<span class="op">=</span><span class="fu">NMcalc</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/NMcalc/man/trapez.html" class="external-link">trapez</a></span><span class="op">(</span><span class="va">TIME</span>,<span class="va">PRED</span><span class="op">)</span><span class="op">)</span></span>
<span>                             ,by<span class="op">=</span><span class="fu">.</span><span class="op">(</span><span class="va">ID</span>,<span class="va">DAY</span>,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># stmp=sres1[EVID==2,.(ID,TIME,PRED)]</span></span>
<span><span class="co"># stmp[,DAY:=(TIME%/%24)+1]</span></span>
<span><span class="co"># sAUC&lt;-stmp[,.(AUC=NMcalc::trapez(TIME,PRED)),by=.(ID,DAY)]</span></span></code></pre></div>
<ul>
<li>at run time, with an <code>NMsim</code> modified script, on a course
grid with evenly spaced time steps of <code>24</code> hours, labelled
<strong>AUC $DES</strong>. Of note, this task requires additions to the
control stream in multiple sections.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># AUC with NMsim -  time step 24hr</span></span>
<span><span class="va">data.sim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/addEVID2.html">addEVID2</a></span><span class="op">(</span><span class="va">data.sim.auc</span><span class="op">[</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">]</span>,CMT<span class="op">=</span><span class="fl">2</span>,time.sim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,by<span class="op">=</span><span class="fl">24</span>,length.out<span class="op">=</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sres.des</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod.auc</span></span>
<span>          ,data<span class="op">=</span><span class="va">data.sim2</span></span>
<span>          ,table.vars<span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/cc.html" class="external-link">cc</a></span><span class="op">(</span><span class="va">PRED</span>,<span class="va">IPRED</span>,<span class="va">AUCNMSIM</span><span class="op">)</span></span>
<span>          ,name.sim<span class="op">=</span><span class="st">"AUC.nmsim"</span></span>
<span>          ,seed<span class="op">=</span><span class="fl">12345</span></span>
<span>          ,reuse.results<span class="op">=</span><span class="va">reuse.results</span></span>
<span>          ,modify.model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>MODEL<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"COMP=(AUC)"</span><span class="op">)</span></span>
<span>                  ,DES<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"DADT(3)=A(2)/V2"</span><span class="op">)</span></span>
<span>                  ,ERROR<span class="op">=</span><span class="fu"><a href="../reference/add.html">add</a></span><span class="op">(</span><span class="st">"AUCCUM=A(3)"</span></span>
<span>                             ,<span class="st">"IF(NEWIND.NE.2) OLDAUCCUM=0"</span></span>
<span>                             ,<span class="st">"AUCNMSIM = AUCCUM-OLDAUCCUM"</span></span>
<span>                             ,<span class="st">"OLDAUCCUM = AUCCUM"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">sres.des</span><span class="op">[</span>,<span class="va">DAY</span><span class="op">:=</span><span class="va">TIME</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span><span class="fl">24</span><span class="op">]</span></span>
<span><span class="va">sres.des</span><span class="op">[</span>,<span class="va">AUC.NMsim</span><span class="op">:=</span><span class="va">AUCNMSIM</span><span class="op">]</span></span>
<span><span class="va">sres.auc.des</span><span class="op">=</span><span class="va">sres.des</span><span class="op">[</span><span class="va">AUCNMSIM</span><span class="op">!=</span><span class="fl">0</span>,<span class="fu">.</span><span class="op">(</span><span class="va">TIME</span>,<span class="va">DAY</span>,<span class="va">PRED</span>,<span class="va">AUC.NMsim</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>The plot comparing the <code>DES</code> and <code>trapez</code> AUC
is obtained with the code below</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sres.final</span><span class="op">=</span><span class="fu"><a href="https://nmautoverse.github.io/NMdata/reference/mergeCheck.html" class="external-link">mergeCheck</a></span><span class="op">(</span><span class="va">sim.auc.trapez</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">DAY</span>,<span class="va">AUC</span>,<span class="va">time.step</span><span class="op">)</span><span class="op">]</span></span>
<span>                      ,<span class="va">sres.auc.des</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span><span class="va">DAY</span>,<span class="va">AUC.NMsim</span><span class="op">)</span><span class="op">]</span></span>
<span>                      ,by<span class="op">=</span><span class="st">"DAY"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">sres.final</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">AUC.NMsim</span>,<span class="va">AUC</span>,colour<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">time.step</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>colour<span class="op">=</span><span class="st">"Time step in fine grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_color_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"blue"</span>, <span class="st">"darkgreen"</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">17</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">17</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"AUC 0-24h by trapez method, on fine grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"AUC 0-24h by integration through $DES, on coarse grid"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_abline</a></span><span class="op">(</span>slope<span class="op">=</span><span class="fl">1</span>, intercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="NMsim-modify-model_files/figure-html/unnamed-chunk-20-1.png" alt="Daily exposures computed at run time ($DES, coarse grid, x-axis) and post-processing time (`trapez`, fine grids, y-axis). AUC (trapez) converges to the value computed with $DES method as the time step is reduced. Includes identity line." width="100%"><p class="caption">
Daily exposures computed at run time ($DES, coarse grid, x-axis) and
post-processing time (<code>trapez</code>, fine grids, y-axis). AUC
(trapez) converges to the value computed with $DES method as the time
step is reduced. Includes identity line.
</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
