<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>NMsim and speed • NMsim</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<script src="../extra.js"></script><meta property="og:title" content="NMsim and speed">
<meta name="google-site-verification" content="-8n-8OfzJii_lVruWfxXOhzUATKSgMdiSxMhOQoscu4">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">NMsim</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fas fa-home fa-lg"></span></a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/NMsim-intro.html">NMsim Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-VPC.html">Simulations for VPCs</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-config.html">Requirements and Configuration</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-known.html">Simulate Known Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ParamUncertain.html">Simulations with Parameter Uncertainty</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-forest.html">Simulation-based forest plots with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-DataCreate.html">Data Set Creation with NMsim</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ResidVar.html">Simulation with Residual Variability</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-varyPars.html">Simulate Models with Modifications</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-ReuseSimSubjects.html">Reuse Simulated Subjects</a></li>
    <li><a class="dropdown-item" href="../articles/NMsim-speed.html">Debugging, Speed, and Disk Space</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">News</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/NMsim-publications.html">Publications</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/NMautoverse/NMsim/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>NMsim and speed</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/NMautoverse/NMsim/blob/main/vignettes/NMsim-speed.Rmd" class="external-link"><code>vignettes/NMsim-speed.Rmd</code></a></small>
      <div class="d-none name"><code>NMsim-speed.Rmd</code></div>
    </div>

    
    
<p>The following points show ways to improve calculation speed with
<code>NMsim</code>. The list is somewhat prioritized, most important
first.</p>
<ul>
<li>Reduce amount of data written to file
<ul>
<li>Almost always use the <code>table.vars</code> argument. Only include
the variables you need out of Nonmem. There is no reason to list
variables in input data since <code>NMsim</code> can merge those back
on. NMsim versions after 0.1.6 have a <code>carry.out</code> argument to
control which input data variables will be recovered. The default is
<code>carry.out=TRUE</code> which means that all input data variables
will be added back on the results. If your data set is very large, and
your input data set has many columns, you can reduce this. You could do
something as little as <code>table.vars=c(PRED, IPRED)</code> and
<code>carry.out=c("ID", "TIME","TRT")</code>.</li>
</ul>
</li>
<li>If running multiple simulations, run them in parallel
<ul>
<li>Use <code>sge=TRUE</code> to submit all simulation runs to the
cluster</li>
</ul>
</li>
<li>Break the simulation into multiple Nonmem runs
<ul>
<li>For example, instead of running <code>subproblems=1000</code>, you
could do <code>subproblems=50, nsims=20, sge=TRUE</code>. In the first
case, one Nonmem model is going through 1000 subproblems. In the second
case, 20 Nonmem runs are going through 50 subproblems each, and the
Nonmem runs are executed in parellel. See example under “Speeding up
large simulations” too.</li>
</ul>
</li>
<li>Use <code>data.table</code>
<ul>
<li>Depending on the data sets this can make a very large difference.
Consider using <code>NMdataConf(as.fun="data.tabe")</code>
</li>
</ul>
</li>
<li>Use <code>method.execute="nmsim"</code>
<ul>
<li>If you provide the path to the Nonmem executable using
<code>path.nonmem</code>, <code><a href="../reference/NMsim.html">NMsim()</a></code> will be default use
<code>method.execute="nmsim"</code>. Trick: configure this once and for
all in the top of your script with something like
<code>NMdata::NMdataConf(path.nonmem="/path/to/nmfe75")</code>.</li>
</ul>
</li>
<li>Parellilize individual runs
<ul>
<li>NMsim does support parellilization (performing a Nonmem run using
multiple cores). For instance, use 16 cores for each Nonmem run by
adding <code>nc=16</code>
</li>
<li>However, this is rarely worth it for simulations. Most of the time,
input/output (reading/writing to disk) is the bottleneck, and splitting
the data set into multiple runs will most often reduce run times
more.</li>
</ul>
</li>
</ul>
<div class="section level2">
<h2 id="most-common-reasons-for-nmsim-to-fail-or-be-slow">Most common reasons for <code>NMsim</code> to fail or be slow<a class="anchor" aria-label="anchor" href="#most-common-reasons-for-nmsim-to-fail-or-be-slow"></a>
</h2>
<p>If <code>NMsim</code> fails or behaves unexpectedly, make sure to
read the output from Nonmem in the R console. If <code>NMsim</code>
complains it cannot find the output tables, it is likely because Nonmem
failed and did not generate them.</p>
<p>Any variable that is used in Nonmem must be defined either inside the
model or in the data set. There may be a covariate in the estimated
model that you did not include in your simulation data set - the
simulation will break. Sometimes the estimation models include variables
in output tables that were not used for anything else by Nonmem than
being read from the input data set and printed in output tables. Imagine
you cleverly included a unique row identifier called <code>ROW</code> in
your estimation data set and listed it in <code>$TABLE</code> to
reliably combine input and output data. It is not used for anything else
in the data. If we do not customize the output table in
<code><a href="../reference/NMsim.html">NMsim()</a></code> using the <code>table.vars</code> argument and the
simulation input data set does not include a numeric <code>ROW</code>
column, we get this error:</p>
<pre><code>Starting NMTRAN
 
 AN ERROR WAS FOUND IN THE CONTROL STATEMENTS.
 
AN ERROR WAS FOUND ON LINE 60 AT THE APPROXIMATE POSITION NOTED:
 $TABLE ROW TVKA TVV2 TVV3 TVCL KA V2 V3 CL Q PRED IPRED Y NOPRINT FILE=NMsim_xgxr021_noname.tab
         X  
 THE CHARACTERS IN ERROR ARE: ROW
  479  THIS ITEM IS NOT LISTED IN MODULE NMPRD4 AND MAY NOT BE DISPLAYED.
cp: cannot stat 'NMsim_xgxr021_noname.tab': No such file or directory
Error in NMscanTables(file, quiet = TRUE, as.fun = "data.table", col.row = col.row,  : 
  NMscanTables: File not found: /home/philip/R/x86_64-pc-linux-gnu-library/4.2/NMsim/examples/nonmem/NMsim/xgxr021_noname/NMsim_xgxr021_noname.tab. Did you copy the lst file but forgot table file?
Results could not be read.</code></pre>
<p>Nonmem gets to writing the <code>$TABLE</code> but cannot find a
variable called <code>ROW</code>. But remember, NMsim normally does not
need a row identifier to combine the input and output data. In many
cases, the best way to fix this is to reduce the <code>$TABLE</code>
section using the <code>table.vars</code> argument. All we need from the
simulation results are population and individual predictions anyway. We
could have omitted <code>ROW</code> in the input data set and done
something as simple as</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span>file.mod<span class="op">=</span><span class="va">file.mod</span>,</span>
<span>                data<span class="op">=</span><span class="va">dat.sim</span>,</span>
<span>                table.vars<span class="op">=</span><span class="st">"PRED IPRED Y"</span><span class="op">)</span></span></code></pre></div>
<p><code>table.vars</code> can help avoid many of these problems. And if
<code>NMsim</code> is slow, this is a large low-hanging fruit. In a
benchmark example, I reduced a (very large) simulation run time from
~1.5 hours to ~7 minutes this way.</p>
</div>
<div class="section level2">
<h2 id="speeding-up-large-simulations">Speeding up large simulations<a class="anchor" aria-label="anchor" href="#speeding-up-large-simulations"></a>
</h2>
<p><code><a href="../reference/NMsim.html">NMsim()</a></code> offers a powerful way to parallellize mutually
independent simulations. This will typically be distinct subjects which
can be simulated without regard to each other. The simple way to do this
is to split the data set into a list of data sets and pass that list in
the <code><a href="../reference/NMsim.html">NMsim()</a></code> <code>data</code> argument.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://NMautoverse.github.io/NMsim/">NMsim</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com" class="external-link">data.table</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">dose1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMcreateDoses.html">NMcreateDoses</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span>,AMT<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">300</span>,<span class="fl">150</span><span class="op">)</span>,</span>
<span>                       addl<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ADDL<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span>,II<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">24</span><span class="op">)</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">1</span>,col.id<span class="op">=</span><span class="cn">NA</span>,</span>
<span>                       as.fun<span class="op">=</span><span class="st">"data.table"</span><span class="op">)</span></span>
<span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="va">dose1</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>ID<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span><span class="op">)</span>,by<span class="op">=</span><span class="va">dose1</span><span class="op">]</span></span>
<span><span class="va">dat.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMaddSamples.html">NMaddSamples</a></span><span class="op">(</span><span class="va">doses</span>,TIME<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="fl">24</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span>,CMT<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## say dt.sim is a large data set with 1000 subjects. We want 10 data</span></span>
<span><span class="co">## sets with 100 subjects in each.</span></span>
<span><span class="va">dat.sim</span><span class="op">$</span><span class="va">IDGRP</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">dat.sim</span><span class="op">$</span><span class="va">ID</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%/%</a></span><span class="fl">100</span><span class="op">+</span><span class="fl">1</span></span>
<span><span class="co">## Now IDGRP is the grouping of the ID's</span></span>
<span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="va">dat.sim</span><span class="op">)</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>minID<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span>,maxID<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span><span class="op">)</span>,by<span class="op">=</span><span class="va">IDGRP</span><span class="op">]</span></span>
<span></span>
<span><span class="co">### with data.table, we easily split the data in a list of data.tables based on that grouping variable</span></span>
<span><span class="va">data.multiple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">dt.sim</span>,by<span class="op">=</span><span class="st">"IDGRP"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## using sge=TRUE we are now sending the run to the cluster as 10 parellel Nonmem runs.</span></span>
<span><span class="va">path.multidata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMsim.html">NMsim</a></span><span class="op">(</span><span class="va">file.mod</span>,</span>
<span>                          data<span class="op">=</span><span class="va">data.multiple</span></span>
<span>                         ,table.vars<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"PRED"</span>,<span class="st">"IPRED"</span>,<span class="st">"Y"</span><span class="op">)</span>,</span>
<span>                         ,name.sim<span class="op">=</span><span class="st">"datalist_01"</span></span>
<span>                         ,sge<span class="op">=</span><span class="cn">TRUE</span></span>
<span>                          <span class="op">)</span></span>
<span><span class="co">### If we want to wait and read the results when they are ready, use wait=TRUE. NMsim will automatically combine them into one data set as if they were from just one Nonmem run.</span></span>
<span><span class="va">simres</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/NMreadSim.html">NMreadSim</a></span><span class="op">(</span><span class="va">path.multidata</span>,wait<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philip Delff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

    </footer>
</div>



  <script data-goatcounter="https://nmsim.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>
</html>
